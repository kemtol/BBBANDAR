<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Service Monitoring — Grid (jQuery)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 24px; background-color: #f8f9fa; }
    .status-badge { text-transform: uppercase; font-weight: 600; }
    .slot-cell { min-width: 90px; cursor: pointer; transition: background-color 0.2s ease-in-out; }
    .slot-cell:hover { background-color: #e9ecef; }
    .slot-pill { display:inline-block; padding:.15rem .5rem; border-radius:999px; font-size:.75rem; font-weight:600; }
    .pill-ok { background:#e7f7ee; border:1px solid #19875450; color:#198754; }
    .pill-fail { background:#fdecea; border:1px solid #dc354550; color:#dc3545; }
    .pill-late { background:#fff7e6; border:1px solid #fd7e1450; color:#fd7e14; }
    .pill-skip { background:#f3f4f6; border:1px solid #6c757d50; color:#6c757d; }
    .pill-run { background:#e7f0ff; border:1px solid #0d6efd50; color:#0d6efd; }
    .result { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background-color: #fff; }
    .jobs-col { width: 220px; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="d-flex align-items-center gap-2 flex-wrap mb-3">
      <h1 class="h5 mb-0">Service Monitoring — Grid Harian</h1>
      <div class="vr"></div>
      <button id="btn-prev" class="btn btn-sm btn-outline-secondary">←</button>
      <input type="date" class="form-control form-control-sm" style="width: 180px" id="inp-date">
      <button id="btn-next" class="btn btn-sm btn-outline-secondary">→</button>
      <div class="vr"></div>
      <select id="sel-preset" class="form-select form-select-sm" style="width: 160px;">
        <option value="today">Hari ini</option>
        <option value="yesterday">Kemarin</option>
      </select>
      <div class="vr"></div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="chk-errors" />
        <label class="form-check-label" for="chk-errors">Tampilkan error saja</label>
      </div>
      <button id="btn-refresh" class="btn btn-sm btn-outline-primary">Refresh</button>
      <span id="last-upd" class="ms-auto text-secondary small"></span>
    </div>

    <div id="kpi" class="d-flex align-items-center gap-2 mb-2 small">
      <span class="badge text-bg-success" id="kpi-ok">OK: 0</span>
      <span class="badge text-bg-warning text-dark" id="kpi-late">LATE: 0</span>
      <span class="badge text-bg-danger" id="kpi-fail">FAIL: 0</span>
      <span class="badge text-bg-secondary" id="kpi-skip">SKIP: 0</span>
      <span class="badge text-bg-info text-dark" id="kpi-run">RUN: 0</span>
      <span class="text-secondary ms-2 fst-italic">SLA: 120 detik (default)</span>
    </div>

    <div class="mb-2 small text-secondary">
      <span class="slot-pill pill-ok">OK</span>
      <span class="slot-pill pill-late ms-1">LATE</span>
      <span class="slot-pill pill-fail ms-1">FAIL</span>
      <span class="slot-pill pill-run ms-1">RUN</span>
      <span class="slot-pill pill-skip ms-1">–</span>
    </div>

    <div class="table-responsive shadow-sm bg-white rounded">
      <table class="table table-sm align-middle table-hover" id="grid">
        <thead class="table-light">
          <tr id="grid-head">
            <th class="jobs-col">Job</th>
            </tr>
        </thead>
        <tbody id="grid-body">
          </tbody>
      </table>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="drawer">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="drawerTitle">Detail Run</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <div id="drawerMeta" class="small mb-2 text-secondary" style="white-space: pre-wrap;"></div>
        <pre id="drawerLog" class="result border rounded p-2 mb-3" style="max-height: 40vh; overflow:auto">Tidak ada log.</pre>
        <a id="drawerLink" href="#" target="_blank" class="btn btn-sm btn-outline-secondary disabled">Open full log</a>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Seluruh kode dijalankan setelah dokumen siap
    $(document).ready(function() {
      // --- DUMMY DATA EMBEDDED ---
      const DUMMY_LATEST_DATA = {
        "fetch_1m": {
          "job": "Fetch 1m",
          "ts": new Date(new Date().setHours(15, 50, 3)).toISOString(),
          "status": "success",
          "exit_code": 0,
          "result": "Fetched 850 symbols successfully.",
          "duration_sec": 45.7
        },
        "fetch_5m": {
          "job": "Fetch 5m",
          "ts": new Date(new Date().setHours(15, 51, 10)).toISOString(),
          "status": "start",
          "result": "Job is currently running, processing chunk 3/10..."
        },
        "fetch_daily": null,
        "core_bpjs": {
          "job": "core-bpjs",
          "ts": new Date(new Date().setHours(10, 32, 15)).toISOString(),
          "status": "error",
          "exit_code": 1,
          "message": "Traceback (most recent call last):\n  File \"service/core-bpjs.py\", line 123, in main\n    raise ConnectionError(\"Failed to connect to database: query timed out after 30s\")\nConnectionError: Failed to connect to database: query timed out after 30s",
          "duration_sec": 30.2,
          "log_url": "/logs/run_slot_2025-08-28.log"
        },
        "rekomendasi": {
          "job": "rekomendasi",
          "ts": new Date(new Date().setHours(15, 53, 0)).toISOString(),
          "ts_end": new Date(new Date().setHours(15, 54, 35)).toISOString(),
          "status": "success",
          "exit_code": 0,
          "result": "Generated 10 recommendations. Output: bpjs_rekomendasi_2025-08-28_1550.csv",
          "duration_sec": 95.1
        },
        "markov": {
          "job": "markov",
          "ts": new Date(new Date().setHours(15, 55, 0)).toISOString(),
          "status": "success",
          "exit_code": 0,
          "result": "Chain probability calculated for 10 candidates.",
          "duration_sec": 135.8
        },
        "kv_sync": {
          "job": "sync KV",
          "ts": new Date(new Date().setHours(15, 55, 5)).toISOString(),
          "status": "success",
          "exit_code": 0,
          "result": "OK",
          "duration_sec": 2.5
        }
      };

      const DEFAULT_SLOTS = ["09:30","10:30","11:30","14:15","15:50","23:59"];
      const DEFAULT_JOBS = [
        { id:"fetch_1m", label:"Fetch 1m", sla_seconds:120, schedule:DEFAULT_SLOTS },
        { id:"fetch_5m", label:"Fetch 5m", sla_seconds:120, schedule:DEFAULT_SLOTS },
        { id:"fetch_15m", label:"Fetch 15m", sla_seconds:120, schedule:DEFAULT_SLOTS },
        { id:"fetch_daily", label:"Fetch daily", sla_seconds:120, schedule:["23:59"] },
        { id:"core_bpjs", label:"core-bpjs", sla_seconds:120, schedule:["10:30", "11:30", "14:15", "15:50"] },
        { id:"rekomendasi", label:"Rekomendasi", sla_seconds:120, schedule:["10:30","15:50"] },
        { id:"kv_sync", label:"Sync KV", sla_seconds:120, schedule:DEFAULT_SLOTS },
        { id:"markov", label:"Markov Chain", sla_seconds:120, schedule:["15:50"] },
      ];

      // --- UI elements (jQuery objects)
      const $gridHead = $('#grid-head');
      const $gridBody = $('#grid-body');
      const $lastUpd  = $('#last-upd');
      const $inpDate  = $('#inp-date');
      const $selPreset= $('#sel-preset');
      const $chkErrors= $('#chk-errors');

      // Drawer
      const drawer = new bootstrap.Offcanvas($('#drawer')[0]);
      const $drawerTitle = $('#drawerTitle');
      const $drawerMeta = $('#drawerMeta');
      const $drawerLog = $('#drawerLog');
      const $drawerLink = $('#drawerLink');

      // KPI
      const KPI = { ok:0, late:0, fail:0, skip:0, run:0 };
      const $kpiEls = {
        ok:   $('#kpi-ok'),   late: $('#kpi-late'), fail: $('#kpi-fail'),
        skip: $('#kpi-skip'), run:  $('#kpi-run'),
      };

      function fmtDateInput(d) { return d.toISOString().slice(0,10); }
      function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

      function pill(status,text) {
        const map = { ok:'pill-ok', fail:'pill-fail', late:'pill-late', run:'pill-run', skip:'pill-skip' };
        return `<span class="slot-pill ${map[status]||'pill-skip'}" title="${text||status}">${(status==='skip')?'–':status.toUpperCase()}</span>`;
      }

      function resetKPI(){ for(const k in KPI){ KPI[k]=0; } }
      function renderKPI(){
        $kpiEls.ok.text('OK: '+KPI.ok);
        $kpiEls.late.text('LATE: '+KPI.late);
        $kpiEls.fail.text('FAIL: '+KPI.fail);
        $kpiEls.skip.text('SKIP: '+KPI.skip);
        $kpiEls.run.text('RUN: '+KPI.run);
      }

      function computeStatus(run, sla){
        if(!run) return 'skip';
        if(run.status === 'start') return 'run';
        if(run.status === 'error' || (run.exit_code != null && run.exit_code > 0)) return 'fail';
        if(run.status === 'success'){
          const dur = run.duration_sec ?? 0;
          return (sla && dur > sla) ? 'late' : 'ok';
        }
        return 'skip';
      }

      // --- Fungsi-fungsi ini tidak perlu diubah karena tidak memanipulasi DOM
      function adaptLatestToDay(latest, dateStr) {
        const day = { date: dateStr, slots:[...DEFAULT_SLOTS], jobs: JSON.parse(JSON.stringify(DEFAULT_JOBS)) };
        const items = Object.values(latest || {}).filter(it => it != null);
        const byJob = {};
        for(const it of items){
          const id = (it.job||'').replaceAll(' ','_').toLowerCase();
          if(!byJob[id]) byJob[id]=[];
          byJob[id].push(it);
        }
        for(const job of day.jobs){
          const arr = byJob[job.id] || [];
          job.runs = [];
          for(const it of arr){
            const slot = nearestSlot(it.ts, day.slots, dateStr);
            if(!slot) continue;
            job.runs.push({
              slot,
              start: it.ts ? new Date(it.ts).toLocaleString('id-ID') : '-',
              end: it.ts_end ? new Date(it.ts_end).toLocaleString('id-ID') : '-',
              status: it.status,
              exit_code: it.exit_code ?? (it.status==='success'?0:1),
              message: it.result || it.message || '',
              command: it.command || '',
              log_url: it.log_url || null,
              duration_sec: it.duration_sec
            });
          }
          const latestPerSlot = {};
          for(const r of job.runs){
            if(!latestPerSlot[r.slot] || (r.start > latestPerSlot[r.slot].start)) latestPerSlot[r.slot]=r;
          }
          job.runs = Object.values(latestPerSlot);
        }
        return day;
      }
      function nearestSlot(ts, slots, dateStr){
        if(!ts) return null;
        try{
          const t = new Date(ts);
          let best=null, bestDiff=1e15;
          for(const s of slots){
            const dt = new Date(`${dateStr}T${s}:00`);
            const diff = Math.abs(t - dt);
            if(diff < bestDiff){ bestDiff=diff; best=s; }
          }
          return best;
        }catch{ return null; }
      }
      // --- Akhir fungsi yang tidak diubah ---

      function renderGrid(day){
        let headHtml = '<th class="jobs-col">Job</th>';
        day.slots.forEach(s => headHtml += `<th class="text-center">${s}</th>`);
        $gridHead.html(headHtml);

        $gridBody.empty(); // Kosongkan body tabel sebelum render ulang
        resetKPI();

        day.jobs.forEach(job => {
          let rowHtml = `<td class="text-nowrap fw-semibold">${job.label}</td>`;
          day.slots.forEach(slot => {
            const isScheduled = (job.schedule || []).includes(slot);
            const run = (job.runs||[]).find(r=>r.slot===slot);
            const st = isScheduled ? computeStatus(run, job.sla_seconds) : 'skip';
            KPI[st]++;
            const tip = run ? `${st.toUpperCase()} | Durasi: ${run.duration_sec||'-'}s\nMsg: ${(run.message||'').slice(0,120)}` : (isScheduled ? 'Belum ada data' : 'Tidak dijadwalkan');
            rowHtml += `<td><div class="slot-cell text-center" data-job="${job.id}" data-slot="${slot}">${pill(st, tip)}</div></td>`;
          });
          $gridBody.append(`<tr>${rowHtml}</tr>`);
        });
        renderKPI();
        applyErrorFilter();
      }

      function applyErrorFilter(){
        const onlyErr = $chkErrors.is(':checked');
        $gridBody.find('tr').each(function() {
          const $row = $(this);
          if (onlyErr) {
            const hasProblem = $row.find('.pill-fail, .pill-late, .pill-run').length > 0;
            $row.toggle(hasProblem);
          } else {
            $row.show();
          }
        });
      }

      function load(){
        const tbodyBusy = `<tr><td colspan="${1+DEFAULT_SLOTS.length}" class="text-secondary p-4 text-center">Memuat data...</td></tr>`;
        $gridBody.html(tbodyBusy);
        try {
          const latest = DUMMY_LATEST_DATA;
          const dateStr = $inpDate.val() || fmtDateInput(new Date());
          const day = adaptLatestToDay(latest, dateStr);
          renderGrid(day);
          $lastUpd.text('Updated: ' + new Date().toLocaleString('id-ID', { dateStyle:'medium', timeStyle:'long'}));
        } catch(e) {
          $gridBody.html(`<tr><td colspan="${1+DEFAULT_SLOTS.length}" class="text-danger p-4 text-center">Gagal memuat data: ${e.message}</td></tr>`);
        }
      }

      // --- Event Handlers ---
      $('#btn-refresh').on('click', load);
      $chkErrors.on('change', applyErrorFilter);

      $('#btn-prev').on('click', function() {
        $inpDate.val(fmtDateInput(addDays(new Date($inpDate.val()||Date.now()), -1)));
        $selPreset.val('today');
        load();
      });

      $('#btn-next').on('click', function() {
        $inpDate.val(fmtDateInput(addDays(new Date($inpDate.val()||Date.now()), +1)));
        $selPreset.val('today');
        load();
      });

      $selPreset.on('change', function() {
        const now = new Date();
        const newDate = $(this).val() === 'yesterday' ? addDays(now, -1) : now;
        $inpDate.val(fmtDateInput(newDate));
        load();
      });

      // Event delegation untuk sel yang dinamis
      $gridBody.on('click', '.slot-cell', function() {
        const $cell = $(this);
        const jobId = $cell.data('job');
        const slot = $cell.data('slot');
        const dateStr = $inpDate.val();
        const dayData = adaptLatestToDay(DUMMY_LATEST_DATA, dateStr);

        const job = dayData.jobs.find(j=>j.id===jobId);
        const run = (job?.runs||[]).find(r=>r.slot===slot);

        if (!run) {
          $drawerTitle.text(`${job?.label||jobId} — ${slot}`);
          $drawerMeta.text('Tidak ada data eksekusi untuk slot ini.');
          $drawerLog.text('-');
          $drawerLink.attr('href', '#').addClass('disabled');
        } else {
          $drawerTitle.text(`${job.label} — ${slot}`);
          const metaText = [
            `Status : ${run.status?.toUpperCase() || '-'} (exit code: ${run.exit_code??'-'})`,
            `Mulai  : ${run.start||'-'}`,
            `Selesai: ${run.end||'-'}`,
            `Durasi : ${run.duration_sec??'-'} detik`,
            `Command: ${run.command||'-'}`
          ].join('\n');
          $drawerMeta.text(metaText);
          $drawerLog.text(run.message || 'Tidak ada pesan.');
          
          if (run.log_url) {
            $drawerLink.attr('href', run.log_url).removeClass('disabled');
          } else {
            $drawerLink.attr('href', '#').addClass('disabled');
          }
        }
        drawer.show();
      });

      // --- Inisialisasi ---
      $inpDate.val(fmtDateInput(new Date()));
      load();
    });
  </script>
</body>
</html>