<!DOCTYPE html>
<html lang="id">
<!--
SSSAHAM Futures Wizard (Chat Style)
Version: v1.9.2
Changelog:
- Full client-side image harvesting (FileReader + localStorage).
- Single POST ke Worker di stage "Analisa Sekarang".
- Global Ctrl+V ‚Üí kirim ke upload bubble aktif (charts/macro).
-->


<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#ffffff" />

    <link rel="manifest" href="img/site.webmanifest" />
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img//favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img//favicon-16x16.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" />

    <title>QUANTA: Free LLM and GPT Agentic AI Tools for Futures and Forex.</title>
    <link rel="stylesheet" href="https://static.mkemalw.workers.dev/" />

    <style>
        .capitalize-first {
            display: inline-block;
            /* penting biar ::first-letter apply */
        }

        .capitalize-first::first-letter {
            text-transform: uppercase;
        }

        .capitalize-first.sentence {
            display: inline-block;
            text-transform: lowercase;
        }

        .capitalize-first.sentence::first-letter {
            text-transform: uppercase;
        }

        /* ===============================
       CHAT LAYOUT (single page scroll)
       =============================== */
        #app.container,
        .chat-wrapper {
            max-width: 720px;
            margin: 0 auto;
        }

        #futures-wizard {
            display: block;
            border: none !important;
            background-color: transparent !important;
        }

        #futures-wizard-wrap {
            display: block;
        }

        .chat-wrapper {
            display: block;
            position: relative;
            border: none !important;
            background: transparent !important;
        }

        /* chat area (NO internal scroll) */
        .chat-shell {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg-row {
            display: flex;
            width: 100%;
        }

        .msg-row.assistant {
            justify-content: flex-start;
        }

        .msg-row.user {
            justify-content: flex-end;
        }

        /* base bubble (assistant default white) */
        .bubble {
            max-width: 85%;
            padding: 1rem 1.2rem;
            border-radius: 14px;
            line-height: 1.45;
            white-space: pre-wrap;
            word-break: break-word;
            background: #fff;
            color: #111;
            border: 1px solid rgba(0, 0, 0, 0.07);
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.02);
        }

        .assistant .bubble {
            border-top-left-radius: 2px;
        }

        /* ‚úÖ user bubble */
        .user .bubble {
            border-top-right-radius: 2px;
            background-color: cornflowerblue;
            color: white;
            border: none;
            margin-bottom: 1rem;
        }

        /* =============== 
        Sticker Bubble (avatar)
        =============== */
        .bubble.sticker-bubble {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0;
            /* biar nempel kayak stiker */
            max-width: 40%;
            /* bebas, bisa diatur lagi */
        }

        .bubble.sticker-bubble img {
            display: block;
            max-width: 120px;
            /* ukuran stiker */
            height: auto;
        }


        /* ===============================
        Upload bubble full width
        =============================== */
        .assistant .bubble.upload-bubble {
            max-width: 100% !important;
            width: 100% !important;
            text-align: center;
        }

        /* analysis bubble full width */
        .assistant .bubble.analysis-bubble {
            max-width: 100% !important;
            width: 100% !important;
        }

        /* analysis bubble jangan ikut pre-wrap */
        .analysis-bubble {
            white-space: normal !important;
        }

        /* kalau ada code/pre mau tetap rapih */
        .analysis-bubble pre,
        .analysis-bubble code {
            white-space: pre-wrap;
        }


        /* small pills */
        .pill {
            display: inline-block;
            border-radius: 999px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: #f8f9fa;
            margin-right: 6px;
            margin-bottom: 6px;
            padding: 6px 14px;
            font-size: .9rem;
        }

        .section-title {
            font-weight: 600;
        }

        /* ===============================
       Quick replies (hover biru)
       =============================== */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .quick-replies .btn {
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 0.9rem;
        }

        /* override hover kalau style.css nabrak */
        .quick-replies .btn.btn-outline-primary:hover,
        .quick-replies .btn.btn-outline-primary:focus {
            background: #0d6efd !important;
            border-color: #0d6efd !important;
            color: #fff !important;
        }

        /* ===============================
       File drop box
       =============================== */
        .file-drop-box {
            border: 1px dashed rgba(108, 117, 125, 0.4);
            border-radius: 10px;
            padding: 2rem 1rem;
            text-align: center;
            background: #fff;
            cursor: pointer;
            min-height: 12rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px;
            position: relative;
        }

        .file-drop-box:hover {
            background: #f8f9fa;
        }

        .file-drop-box .cloud-icon {
            color: #6c757d;
            font-size: 32px;
        }

        .file-drop-box .hint {
            color: #6c757d;
            font-size: 0.92rem;
        }

        .file-drop-box.drag-over {
            background: #eef6ff;
            border-color: rgba(13, 110, 253, 0.4);
        }

        /* Grid preview tetap */
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 8px;
            width: 100%;
            margin-top: 8px;
        }

        /* Bungkus tiap item biar X nempel di dalam gambar */
        .preview-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
            white-space: normal;
        }

        /* Override img di dalam preview-item */
        .preview-item img {
            display: block;
            width: 100%;
            height: 110px;
            object-fit: contain;
            padding: 4px;
        }

        /* Tombol close kecil bulat di pojok kanan atas */
        .preview-item .preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.8);
            color: #fff;
            font-size: 0.8rem;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            padding: 0;
        }

        /* Quick reply Confirm di kanan, tidak "gelambir" */
        .quick-replies.upload-confirm {
            justify-content: flex-start;
            align-items: center;
        }

        .quick-replies.upload-confirm .confirm-upload-btn {
            border-radius: 999px;
            padding: 6px 18px;
            font-size: 0.9rem;
            white-space: initial;
        }

        .quick-replies.upload-confirm .remaining-hint {
            display: inline-flex;
            /* biar bisa di-center juga */
            align-items: center;
            line-height: 1.2;
            margin-top: 0;
            /* jaga-jaga kalau kepengaruh margin default */
        }

        /* ===============================
   Upload actions (Galeri / Kamera)
   =============================== */
        .upload-controls {
            margin-top: 12px;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .upload-btn {
            border-radius: 999px;
            padding: 6px 18px;
            font-size: 0.9rem;
            border: 1px solid #d0d7e2;
            background: #ffffff;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .upload-btn i {
            font-size: 0.95rem;
        }

        /* varian Galeri (netral) */
        .upload-btn-gallery {
            color: #111827;
        }

        /* varian Kamera (primary outline) */
        .upload-btn-camera {
            border-color: #0d6efd;
            color: #0d6efd;
            background: #f5f8ff;
        }

        .upload-btn:hover,
        .upload-btn:focus {
            background: #f3f4f6;
        }

        .upload-btn-camera:hover,
        .upload-btn-camera:focus {
            background: #e5f0ff;
        }

        /* mobile: full width biar rapi */
        @media (max-width: 480px) {
            .upload-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .upload-btn {
                width: 100%;
                justify-content: center;
            }
        }


        /* ===============================
       Table styling
       =============================== */
        .analysis-table {
            font-size: 0.9rem;
            margin-bottom: 0;
        }

        .analysis-table td,
        .analysis-table th {
            vertical-align: top;
            padding: 6px 8px;
        }

        .analysis-table th {
            width: 140px;
            color: #6c757d;
            font-weight: 600;
            background: #f8f9fa;
        }

        /* === PATCH v1.7.0 === */

        /* Hilangin gap karena <p> default margin di bubble */

        .bubble ul,
        .bubble ol {
            margin: 0 !important;
            padding-left: 1.1rem;
        }

        /* Quick replies hover harus biru */
        .quick-replies .btn {
            border-radius: 999px;
            padding: 6px 14px;
            font-size: .9rem;
            transition: .12s ease-in-out;
        }

        .quick-replies .btn:hover,
        .quick-replies .btn:focus {
            background: #0d6efd !important;
            border-color: #0d6efd !important;
            color: #fff !important;
        }

        /* Table look lebih rapi di analysis bubble */
        .analysis-bubble .table {
            font-size: .9rem;
        }

        .analysis-bubble .table td {
            vertical-align: top;
        }


        /* ===============================
       Composer FIXED bottom
       =============================== */
        .chat-composer {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            margin: 0 auto;
            width: min(720px, calc(100% - 2rem));
            z-index: 999;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(0, 0, 0, 0.12);
            padding: 8px;
            border-radius: 12px 12px 0 0;
            backdrop-filter: blur(4px);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.06);
        }

        .chat-composer.disabled {
            pointer-events: none;
        }

        .chat-composer.disabled .input-group {
            opacity: 0.3;
        }

        .chat-composer textarea {
            resize: none;
            max-height: 120px;
        }
    </style>
</head>

<body>
    <div id="app" class="container">
        <section id="home-page">
            <div class="this-page border-bottom d-flex flex-row align-items-center justify-content-between px-3 py-1 mt-4"
                style="background: transparent !important;border: none!important;">
                <h2 class="d-flex text-center fs-6" style="font-weight: 500;">üëã Hi, Quant Trader!</h2>
                <a href="performance-report.html" id="performance-report" class="d-flex btn btn-lg p-0">
                    <img src="img/pie-chart.png" style="width: 24px;">
                </a>
            </div>

            <div class="this-page my-3 p-2" style="background-color: #e8ecec !important;">
                <p class="d-block text-center mb-0">
                    Dapatkan rekomendasi Agentic AI. <a href="about-us.html" style="color: dodgerblue;">Pelajari Lebih
                        Lanjut</a>
                </p>
            </div>

            <!-- Futures Wizard -->
            <div id="futures-wizard" class="mb-4">
                <div id="futures-wizard-wrap"></div>
                <div id="futures-wizard-alert-wrap" class="mt-2" aria-live="polite"></div>
            </div>
        </section>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>

        // ---------------------------
        // Global helper functions
        // ---------------------------

        // otomatis deteksi development vs production
        const isMobileDevice = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        const WORKER_URL = isLocal
        ? "http://127.0.0.1:8789/pass-imgs"
        : "https://asset-router.mkemalw.workers.dev/pass-imgs";


        // ===== Local storage helper =====
        const STORAGE_KEYS = {
            charts: "fw_charts_v1",
            macro: "fw_macro_v1",
        };

        function saveImagesToStorage(storageKey, filesArr) {
            try {
                localStorage.setItem(storageKey, JSON.stringify(filesArr));
            } catch (err) {
                console.warn("Failed to save images to localStorage:", err);
            }
        }

        function loadImagesFromStorage(storageKey) {
            try {
                const raw = localStorage.getItem(storageKey);
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (err) {
                console.warn("Failed to load images from localStorage:", err);
                return [];
            }
        }


        function humanizeLabel(v) {
            if (v === null || v === undefined) return "TBD";
            const s = String(v).trim();
            if (!s) return "TBD";

            // ganti _ jadi spasi
            const withSpaces = s.replace(/_/g, " ");

            // Title Case tiap kata
            return withSpaces.replace(/\w\S*/g, (w) =>
                w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()
            );
        }

        function pretty(v) {
            if (v === null || v === undefined || v === "") return "TBD";
            const s = String(v);
            return s.includes("_") ? humanizeLabel(s) : s;
        }


        function stripWhitespaceNodes($root) {
            $root.find("*").addBack().contents().filter(function () {
                return this.nodeType === 3 && !this.textContent.trim();
            }).remove();
        }


        function showWarning(message) {
            const warningDiv = $("<div class='alert alert-danger mt-2' role='alert'></div>").text(message);
            const alertContainer = $("#futures-wizard-alert-wrap");
            alertContainer.prepend(warningDiv);
            const alerts = alertContainer.children('.alert');
            if (alerts.length > 3) alerts.last().remove();
            setTimeout(() => warningDiv.fadeOut(() => warningDiv.remove()), 2600);
        }

        let activeUploadCtx = null;

        $(document).ready(function () {
            // ---------------------------
            // State
            // ---------------------------
            let wizardState = {
                pair: null,      // "gold" | "nasdaq"
                style: null,     // "intraday" | "swing"
                charts: [],
                macro: [],
                acceptedTrade: null
            };

            // ---------------------------
            // UI setup (chat + composer)
            // ---------------------------
            const wrap = $("#futures-wizard-wrap");

            const wrapper = $(`
        <div class="chat-wrapper" id="chat-wrapper">
          <div class="chat-shell" id="chat-shell"></div>

          <div class="chat-composer disabled" id="chat-composer">
            <div class="input-group">
              <textarea id="composer-input" class="form-control" rows="1"
                placeholder="Composer akan aktif setelah rekomendasi keluar..." disabled></textarea>
              <button class="btn btn-primary" id="composer-send" disabled>
                <i class="fa-solid fa-paper-plane" style="color:white!important"></i>
              </button>
            </div>
            <div class="small text-muted mt-1 text-center" id="composer-hint">
              <small style="visibility:hidden">Composer akan nyala setelah rekomendasi (JSON) muncul.</small>
            </div>
          </div>
        </div>
      `);

            wrap.append(wrapper);
            const chat = $("#chat-shell");
            const chatWrapper = $("#chat-wrapper");

            // reserve padding-bottom dynamically to avoid overlap
            function syncComposerReserve() {
                const h = $("#chat-composer").outerHeight() || 0;
                chatWrapper.css("padding-bottom", (h + 16) + "px");
            }
            syncComposerReserve();
            $(window).on("resize", syncComposerReserve);

            function scrollToBottom() {
                window.scrollTo(0, document.body.scrollHeight);
            }

            function addMessage(role, html) {
                const row = $(`<div class="msg-row ${role}"></div>`);
                const bubble = $(`<div class="bubble"></div>`);
                bubble.append(html);
                stripWhitespaceNodes(bubble);
                row.append(bubble);
                chat.append(row);
                syncComposerReserve();
                scrollToBottom();
                return bubble;
            }

            function addAssistantText(text) {
                return addMessage("assistant", `<div>${text}</div>`);
            }
            function addUserText(text) {
                return addMessage("user", `<div>${text}</div>`);
            }

            function requiredCharts() {
                return wizardState.style === "swing"
                    ? ["4H Chart", "15M Chart", "5M Chart"]
                    : ["15M Chart", "5M Chart", "1M Chart"];
            }

            // ---------------------------
            // Quick replies helper
            // ---------------------------
            function addQuickReplies(bubble, options) {
                const qr = $(`<div class="quick-replies mb-3"></div>`);
                options.forEach(opt => {
                    const btn = $(`<button class="btn btn-outline-primary btn-sm"></button>`);
                    btn.text(opt.label);
                    btn.on("click", opt.onClick);
                    qr.append(btn);
                });
                bubble.append(qr);
            }

            // ---------------------------
            // Composer enable/disable
            // ---------------------------
            function enableComposer() {
                $("#chat-composer").removeClass("disabled");
                $("#composer-input, #composer-send").prop("disabled", false);
                $("#composer-hint").addClass("d-none");
                $("#composer-input").attr("placeholder", "Ketik respon kamu di sini...");
                syncComposerReserve();
                scrollToBottom();
            }
            function disableComposer() {
                $("#chat-composer").addClass("disabled");
                $("#composer-input, #composer-send").prop("disabled", true);
                $("#composer-input").val("").attr("placeholder", "Composer akan aktif setelah rekomendasi keluar...");
                $("#composer-hint").removeClass("d-none");
                syncComposerReserve();
            }

            $("#composer-send").on("click", function () {
                const val = $("#composer-input").val().trim();
                if (!val) return;
                addUserText(val);
                $("#composer-input").val("");
            });

            $("#composer-input").on("keydown", function (e) {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    $("#composer-send").click();
                }
            });

            // Global handler: kalau ada image di clipboard, kirim ke upload bubble aktif
            $(document).on("paste", function (e) {
                if (!activeUploadCtx) return;

                // Jangan ganggu kalau user lagi ngetik di input / textarea / contenteditable
                const target = e.target;
                if ($(target).is("input, textarea, [contenteditable=true]")) {
                    return;
                }

                const evt = e.originalEvent || e;
                const clipboardData = evt.clipboardData || window.clipboardData;
                if (!clipboardData || !clipboardData.items) return;

                const files = [];
                for (let i = 0; i < clipboardData.items.length; i++) {
                    const item = clipboardData.items[i];
                    if (item.kind === "file" && item.type.startsWith("image/")) {
                        const f = item.getAsFile();
                        if (f) files.push(f);
                    }
                }

                if (!files.length) return; // tidak ada image di clipboard

                e.preventDefault(); // cegah paste teks random ke halaman
                activeUploadCtx.appendFiles(files);  // pakai fungsi dari bubble aktif
            });


            // ---------------------------
            // Upload bubble (HARVEST + localStorage, TANPA POST)
            // ---------------------------
            function addUploadBubble({ title, hint, onFiles, storageKey, minCount = 1 }) {
                const bubble = addMessage("assistant", "");
                bubble.addClass("upload-bubble");

                const titleEl = $("<div></div>")
                    .addClass("fw-semibold mt-2 mb-1")
                    .text(title);

                const hintEl = $("<div></div>")
                    .addClass("text-muted small mb-2")
                    .text(hint);

                // Dropzone utama
                const box = $(`
                    <div class="file-drop-box my-3" tabindex="0">
                        <i class="fa-solid fa-cloud-arrow-up cloud-icon"></i>
                        <div class="hint mb-3">Tap / drop semua gambar sekaligus</div>

                        <input type="file" class="uploader" multiple accept="image/*"
                        style="position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;" />

                        <div class="preview-grid d-none"></div>
                    </div>
                    `);

                const input = box.find("input.uploader");
                const preview = box.find(".preview-grid");

                // Kontrol ekstra (mobile only)
                const controls = $(`
                    <div class="upload-controls">
                        <button type="button"
                        class="btn btn-sm upload-btn upload-btn-gallery pick-gallery-btn">
                        <i class="fa-regular fa-image"></i>
                        <span>Galeri</span>
                        </button>
                        <button type="button"
                        class="btn btn-sm upload-btn upload-btn-camera camera-btn">
                        <i class="fa-solid fa-camera"></i>
                        <span>Kamera</span>
                        </button>
                        <input type="file" class="camera-input d-none"
                        accept="image/*" capture="environment" />
                    </div>
                    `);
                const cameraInput = controls.find(".camera-input");


                const confirmWrap = $(`
                    <div class="quick-replies upload-confirm mt-2 mb-3 d-none">
                        <button type="button" class="btn btn-outline-primary btn-sm confirm-upload-btn">
                        Confirm
                        </button>
                        <small class="remaining-hint ms-2"
                        style="color:orange; font-size:0.8rem; display:none;"></small>
                    </div>
                    `);

                const confirmBtn = confirmWrap.find(".confirm-upload-btn");
                const remainingHint = confirmWrap.find(".remaining-hint");

                // Staging gambar sebelum di-confirm
                let staged = [];

                function renderPreview() {
                    preview.empty();

                    if (!staged.length) {
                        preview.addClass("d-none");
                        confirmWrap.addClass("d-none");
                        remainingHint.hide(); // ga ada gambar, ga usah nunjukin
                        return;
                    }

                    preview.removeClass("d-none");
                    confirmWrap.removeClass("d-none");

                    staged.forEach((f, idx) => {
                        preview.append(`
                        <div class="preview-item" data-index="${idx}">
                            <button type="button" class="preview-remove" aria-label="Hapus gambar">&times;</button>
                            <img src="${f.data}" alt="preview">
                        </div>
                        `);
                    });

                    // üîê Atur tombol Confirm + hint ‚Äúberapa lagi‚Äù
                    if (staged.length < minCount) {
                        const remaining = minCount - staged.length;

                        confirmBtn.prop("disabled", true);
                        confirmBtn.text(`Confirm (${staged.length}/${minCount})`);

                        // kalau minCount > 1 baru masuk akal kasih hint
                        if (minCount > 1) {
                            remainingHint
                                .text(`${remaining} screenshot lagi!`)
                                .show();
                        } else {
                            remainingHint.hide();
                        }
                    } else {
                        confirmBtn.prop("disabled", false);
                        confirmBtn.text("Confirm");
                        remainingHint.hide();
                    }
                }


                async function appendFiles(fileList) {
                    const files = [...fileList].filter(f => f.type.startsWith("image/"));
                    if (!files.length) {
                        showWarning("File harus berupa gambar.");
                        return;
                    }

                    const newItems = await Promise.all(
                        files.map(
                            file =>
                                new Promise(resolve => {
                                    const reader = new FileReader();
                                    reader.onload = e => {
                                        resolve({ name: file.name, data: e.target.result });
                                    };
                                    reader.readAsDataURL(file);
                                })
                        )
                    );

                    staged = staged.concat(newItems);
                    renderPreview();
                }

                activeUploadCtx = {
                    appendFiles,  // refer ke fungsi di bubble ini
                };

                function confirmUpload() {
                    if (!staged.length || staged.length < minCount) return; // safety

                    const base64Arr = staged.map(f => ({ name: f.name, data: f.data }));

                    if (storageKey) {
                        saveImagesToStorage(storageKey, base64Arr);
                    }

                    onFiles(base64Arr.map(f => f.data));

                    input.prop("disabled", true).css("pointer-events", "none");
                    if (isMobileDevice) {
                        controls.find("button").prop("disabled", true);
                        cameraInput.prop("disabled", true);
                    }
                    confirmBtn.text("Confirmed").prop("disabled", true);
                    remainingHint.hide();
                    activeUploadCtx = null;
                }

                // === EVENTS ===
                // keyboard
                box.on("keydown", e => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        input[0].click();
                    }
                });

                // file via input utama
                input.on("change", e => {
                    if (!e.target.files?.length) return;
                    appendFiles(e.target.files);
                    e.target.value = "";
                });

                // drag & drop
                box.on("dragover", e => {
                    e.preventDefault();
                    e.originalEvent.dataTransfer.dropEffect = "copy";
                    box.addClass("drag-over");
                });
                box.on("dragleave drop", e => {
                    e.preventDefault();
                    box.removeClass("drag-over");
                });
                box.on("drop", e => {
                    e.preventDefault();
                    const dt = (e.originalEvent || e).dataTransfer;
                    if (!dt?.files?.length) return;
                    appendFiles(dt.files);
                });

                // hapus per gambar
                preview.on("click", ".preview-remove", function () {
                    const idx = $(this).closest(".preview-item").data("index");
                    staged.splice(idx, 1);
                    renderPreview();
                });

                // Confirm
                confirmBtn.on("click", e => {
                    e.preventDefault();
                    e.stopPropagation();
                    confirmUpload();
                });

                // Mobile only: Galeri / Kamera
                if (isMobileDevice) {
                    controls.find(".pick-gallery-btn").on("click", () => input[0].click());
                    controls.find(".camera-btn").on("click", () => cameraInput[0].click());

                    cameraInput.on("change", e => {
                        if (!e.target.files?.length) return;
                        appendFiles(e.target.files);
                        e.target.value = "";
                    });

                    bubble.append(titleEl, hintEl, box, controls, confirmWrap);
                } else {
                    // Desktop: hanya dropzone + Confirm
                    bubble.append(titleEl, hintEl, box, confirmWrap);
                }

                scrollToBottom();
            }


            // ---------------------------
            // Analysis bubble (TABLE-BASED)
            // ---------------------------
            function valOrTbd(v) {
                if (v === null || v === undefined || v === "" || (Array.isArray(v) && !v.length)) return "TBD";
                return v;
            }

            function listToHtml(arr) {
                if (!arr || !arr.length) return "TBD";
                return `<ul class="mb-0 ps-3">${arr.map(x => `<li>${x}</li>`).join("")}</ul>`;
            }

            function renderEvidenceTable(title, arr) {
                const wrap = $("<div></div>").addClass("mb-2");
                wrap.append($("<div></div>").addClass("small fw-semibold text-muted mb-1").text(title));

                if (!arr || !arr.length) {
                    wrap.append($("<div></div>").addClass("small text-muted").text("Tidak ada data."));
                    return wrap;
                }

                const table = $(`
          <div class="table-responsive">
            <table class="table table-sm table-bordered analysis-table mb-0">
              <thead>
                <tr>
                  <th style="width:160px">Item</th>
                  <th style="width:120px">State</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        `);

                const tbody = table.find("tbody");
                arr.forEach(x => {
                    tbody.append(`
            <tr>
              <td><strong>${x.item}</strong></td>
              <td>${valOrTbd(x.state)}</td>
              <td>${valOrTbd(x.note)}</td>
            </tr>
          `);
                });

                wrap.append(table);
                return wrap;
            }

            // ---------------------------
            // Render analysis bubble (TABLE view)
            // v1.7.0
            // ---------------------------
            function renderAnalysisBubble(jsonObj) {
                const bubble = addMessage("assistant", "");
                bubble.addClass("analysis-bubble");

                const uniqueId = "raw-json-" + Date.now() + "-" + Math.floor(Math.random() * 9999);
                const assetType = jsonObj.asset_type || "TBD";
                const md = jsonObj.macro_dashboard || {};
                const bias = jsonObj.market_bias || {};
                const lm = jsonObj.liquidity_map || {};
                const td = jsonObj.trade_direction || {};
                const tp = jsonObj.trade_plan || {};
                const seOut = jsonObj.citadel_multi_asset_scoring_engine?.output || {};

                // helper safe text
                const safe = (v, fallback = "TBD") => (v === null || v === undefined || v === "" ? fallback : v);
                const joinBr = (arr) => (arr && arr.length) ? arr.join("<br>") : "TBD";

                // ===== Header =====
                const header = $(`
    <div class="mb-2">
        <div class="d-flex flex-column gap-1">
        <h5 class="fw-semibold">Rekomendasi ${assetType}</h5>
        <span>${humanizeLabel(safe(md.macro_to_asset_bias))}</span>
        <div class="mt-2 mb-4"><span class="pill">Regime: ${humanizeLabel(safe(md.macro_regime))}</span><span class="pill">Confidence: ${humanizeLabel(safe(md.confidence_pct))}%</span></div>
      </div>
    </div>
  `);
                stripWhitespaceNodes(header);
                bubble.append(header);

                // ===== Macro Dashboard Tables =====

                bubble.append(`<h6 class="section-title mb-4">Macro Dashboard</h6>`);

                function macroTable(title, rows) {
                    if (!rows || !rows.length) {
                        return $(`<div class="small text-muted mb-2">Tidak ada data.</div>`);
                    }

                    const table = $(`
      <div class="table-responsive mb-2">
        <table class="table table-sm table-borderless align-middle mb-0 macro-2col">
          <tbody></tbody>
        </table>
      </div>
    `);

                    const tbody = table.find("tbody");

                    rows.forEach(r => {
                        const itemTxt = pretty(r.item);
                        const stateTxt = pretty(r.state);
                        const noteTxt = pretty(r.note);

                        tbody.append(`
          <tr>
            <td style="width:35%" class="px-0">
              <strong>${itemTxt} is <span style="text-transform:lowercase">${stateTxt}</span></strong>
            </td>
            <td class="ps-0"><span class="capitalize-first sentence">${noteTxt}</span></td>
          </tr>
        `);
                    });

                    return table;
                }


                // ===== Macro Dashboard Tables (MERGED, 2 COL) =====
                const assetUpper = String(assetType).toUpperCase();

                const mergedMacroRows = [
                    ...(md.common_evidence || []),
                    ...((assetUpper === "GOLD") ? (md.gold_specific || []) : []),
                    ...((assetUpper === "NASDAQ") ? (md.nasdaq_specific || []) : [])
                ];

                bubble.append(macroTable("Macro View", mergedMacroRows));



                // ===== Market Bias Tables =====
                bubble.append(`<div class="section-title">Market Bias</div>`);

                const tfKeys = Object.keys(bias).filter(tf => bias[tf]); // skip null tf
                if (!tfKeys.length) {
                    bubble.append(`<div class="small text-muted mb-2">Tidak ada data market bias.</div>`);
                } else {
                    tfKeys.forEach(tf => {
                        const b = bias[tf];
                        const keyLevels = (b.key_levels && b.key_levels.length) ? b.key_levels.join(", ") : "TBD";
                        const intLiq = joinBr(b.liquidity?.internal);
                        const extLiq = joinBr(b.liquidity?.external);
                        const fvg = joinBr(b.imbalances_fvg);

                        bubble.append(`
        <div class="small fw-semibold text-muted mb-1">${tf}</div>
        <div class="table-responsive mb-2">
          <table class="table table-sm table-bordered mb-0">
            <tbody>
              <tr><td style="width:28%"><strong>Summary</strong></td><td>${pretty(b.summary)}</td></tr>
              <tr><td><strong>Trend</strong></td><td>${pretty(b.trend)}</td></tr>
              <tr><td><strong>Structure</strong></td><td>${pretty(b.structure)}</td></tr>
              <tr><td><strong>Momentum</strong></td><td>${pretty(b.momentum)}</td></tr>
              <tr><td><strong>Volatility</strong></td><td>${pretty(b.volatility)}</td></tr>
              <tr><td><strong>Key Levels</strong></td><td>${keyLevels}</td></tr>
              <tr><td><strong>Internal Liquidity</strong></td><td>${intLiq}</td></tr>
              <tr><td><strong>External Liquidity</strong></td><td>${extLiq}</td></tr>
              <tr><td><strong>FVG/Imbalances</strong></td><td>${fvg}</td></tr>
              <tr><td><strong>Trigger</strong></td><td>${pretty(b.trigger)}</td></tr>
              <tr><td><strong>Confidence</strong></td><td>${pretty(b.confidence_pct)}%</td></tr>
            </tbody>
          </table>
        </div>
      `);
                    });
                }

                // ===== Liquidity Map =====
                bubble.append(`<div class="section-title">Liquidity Map</div>`);
                bubble.append(`
                    <div class="table-responsive mb-2">
                        <table class="table table-sm table-bordered mb-0">
                            <tbody>
                            <tr><td style="width:28%"><strong>Internal</strong></td><td>${joinBr(lm.internal_liquidity)}</td></tr>
                            <tr><td><strong>External</strong></td><td>${joinBr(lm.external_liquidity)}</td></tr>
                            <tr><td><strong>Sweep Expectation</strong></td><td>${safe(lm.sweep_expectation)}</td></tr>
                            <tr><td><strong>Imbalance/FVG Zones</strong></td><td>${joinBr(lm.imbalance_fvg_zones)}</td></tr>
                            </tbody>
                        </table>
                    </div>
                `);

                // ===== Trade Direction =====
                bubble.append(`<div class="section-title">Trade Direction</div>`);
                bubble.append(`
                    <div class="table-responsive mb-2">
                        <table class="table table-sm table-bordered mb-0">
                            <tbody>
                            <tr><td style="width:28%"><strong>Choice</strong></td><td>${safe(td.choice)}</td></tr>
                            <tr><td><strong>Rationale</strong></td><td>${safe(td.rationale)}</td></tr>
                            </tbody>
                        </table>
                    </div>
                `);

                // ===== Trade Plan =====
                bubble.append(`<div class="section-title">Trade Plan</div>`);

                const targets = (tp.targets || []).map(t => {
                    const k = Object.keys(t).find(x => x.startsWith("T")) || "T?";
                    return `${k}: ${t[k]} ‚Äî ${t.action || ""}`;
                }).join("<br>") || "TBD";

                bubble.append(`
                    <div class="table-responsive mb-2">
                        <table class="table table-sm table-bordered mb-0">
                            <tbody>
                            <tr><td style="width:28%"><strong>Context Confluence</strong></td><td>${joinBr(tp.context_confluence)}</td></tr>
                            <tr><td><strong>Entry</strong></td><td>${safe(tp.entry?.type)} @ ${(tp.entry?.zone || []).join("‚Äì") || "TBD"}<br><span class="text-muted">${safe(tp.entry?.trigger, "")}</span></td></tr>
                            <tr><td><strong>Invalidation</strong></td><td>SL ${safe(tp.invalidation?.hard_stop)}<br><span class="text-muted">${safe(tp.invalidation?.condition, "")}</span></td></tr>
                            <tr><td><strong>Targets</strong></td><td>${targets}</td></tr>
                            <tr><td><strong>Risk</strong></td><td>max risk ${safe(tp.risk?.max_account_risk_pct)}% | ${safe(tp.risk?.notes)}</td></tr>
                            <tr><td><strong>No-Trade</strong></td><td>${joinBr(tp.no_trade_conditions)}</td></tr>
                            </tbody>
                        </table>
                    </div>
            `);

                // ===== Scoring Engine =====
                bubble.append(`<div class="section-title">Citadel Scoring Engine</div>`);
                bubble.append(`
                    <div class="table-responsive mb-2">
                        <table class="table table-sm table-bordered mb-0">
                            <tbody>
                            <tr><td style="width:28%"><strong>Detected Asset</strong></td><td>${safe(seOut.detected_asset)}</td></tr>
                            <tr><td><strong>Regime</strong></td><td>${safe(seOut.regime)}</td></tr>
                            <tr><td><strong>Scores</strong></td>
                                <td>macro ${safe(seOut.macro_score)} | technical ${safe(seOut.technical_score)} | liquidity ${safe(seOut.liquidity_score)} | event ${safe(seOut.event_score)}</td></tr>
                            <tr><td><strong>Final Confidence</strong></td><td>${safe(seOut.final_confidence_pct)}%</td></tr>
                            </tbody>
                        </table>
                    </div>
                `);

                // ===== Raw JSON collapsible =====
                const rawWrap = $(`
                    <div class="mt-2 d-none">
                        <button class="btn btn-sm btn-outline-secondary w-100" type="button"
                        data-bs-toggle="collapse" data-bs-target="#${uniqueId}">
                            Lihat / Copy JSON mentah
                        </button>
                        <div id="${uniqueId}" class="collapse mt-2"></div>
                    </div>
                `);
                const rawCode = $("<code></code>").addClass("json small").text(JSON.stringify(jsonObj, null, 2));
                rawWrap.find("#" + uniqueId).append(rawCode);
                bubble.append(rawWrap);

                scrollToBottom();
            }

            // ---------------------------
            // Steps (chat style)
            // ---------------------------
            function step1_pair() {
                const b = addAssistantText("<p>Pair apa yang mau kamu analisa? Pilih salah satu:</p>");
                addQuickReplies(b, [
                    { label: "Gold", onClick: () => choosePair("gold") },
                    { label: "Nasdaq", onClick: () => choosePair("nasdaq") }
                ]);
            }

            function choosePair(pair) {
                wizardState.pair = pair;
                addUserText("üëå " + pair.toUpperCase());
                step2_style();
            }

            function step2_style() {
                const b = addAssistantText("<p>Trading style kamu Intraday atau Swing?</p>");
                addQuickReplies(b, [
                    { label: "Intraday", onClick: () => chooseStyle("intraday") },
                    { label: "Swing", onClick: () => chooseStyle("swing") }
                ]);
            }

            function chooseStyle(style) {
                wizardState.style = style;
                addUserText("üëç " + style.toUpperCase());
                step3_uploadCharts();
            }

            function step3_uploadCharts() {
                const req = requiredCharts();
                addAssistantText(
                    `<p class="mb-2">Oke. Sekarang upload chart berikut sekaligus dalam 1 kali kirim:</p><p>‚Ä¢ ${req.join("<br/>‚Ä¢ ")}</p>`
                );

                addUploadBubble({
                    title: "Upload Chart Screenshots",
                    hint: `Wajib minimal ${req.length} gambar sesuai list di atas.`,
                    storageKey: STORAGE_KEYS.charts,
                    minCount: req.length,                // ‚¨ÖÔ∏è WAJIB 3 untuk swing / intraday
                    onFiles: (imgs) => {
                        if (imgs.length < req.length) {
                            showWarning(`Minimal ${req.length} chart ya (${req.join(", ")})`);
                            return;
                        }
                        wizardState.charts = imgs;
                        addUserText(`‚úÖ Charts di-upload (${imgs.length} file).`);
                        step4_uploadMacro();
                    }
                });
            }

            function step4_uploadMacro() {
                addAssistantText(
                    `<p class="mb-2">Sekarang upload screenshot macro sekaligus (boleh lebih dari 2 file):</p><p>‚Ä¢ VIX<br>‚Ä¢ US10Y<br>‚Ä¢ DXY<br>‚Ä¢ Yield curve / macro dashboard lain</p>`
                );

                addUploadBubble({
                    title: "Upload Macro Screenshots",
                    hint: "Drop/tap untuk upload semua macro metrics (minimal 2 gambar).",
                    storageKey: STORAGE_KEYS.macro,
                    minCount: 2,                          // ‚¨ÖÔ∏è bebas: 1 / 2 / 3 sesuai mau kamu
                    onFiles: (imgs) => {
                        wizardState.macro = imgs;
                        addUserText(`‚úÖ Macro di-upload (${imgs.length} file).`);
                        step5_confirmAndAnalyze();
                    }
                });
            }

            function step5_confirmAndAnalyze() {
                const req = requiredCharts();
                const b = addAssistantText(
                    `<p>Sebelum analisa, kita confirm dulu:</p><p><strong>Pair:</strong> ${wizardState.pair.toUpperCase()}
<strong>Style:</strong> ${wizardState.style.toUpperCase()}
<strong>Required charts:</strong> ${req.join(", ")}
<strong>Charts uploaded:</strong> ${wizardState.charts.length}
<strong>Macro uploaded:</strong> ${wizardState.macro.length}<br>
Klik "Analisa Sekarang" untuk generate rekomendasi (JSON).</p>`
                );

                addQuickReplies(b, [
                    { label: "Analisa Sekarang", onClick: () => generateJsonResponse() },
                    { label: "Ulang Upload Charts", onClick: () => restartFromCharts() },
                    { label: "Ulang Upload Macro", onClick: () => restartFromMacro() }
                ]);
            }

            function restartFromCharts() {
                addUserText("Ulang upload charts.");
                wizardState.charts = [];
                step3_uploadCharts();
            }

            function restartFromMacro() {
                addUserText("Ulang upload macro.");
                wizardState.macro = [];
                step4_uploadMacro();
            }

            async function generateJsonResponse() {
                addUserText("Analisa sekarang.");

                const chartsRaw = loadImagesFromStorage(STORAGE_KEYS.charts); // [{name,data}]
                const macroRaw = loadImagesFromStorage(STORAGE_KEYS.macro);  // [{name,data}]
                const reqCharts = requiredCharts(); // ["15M Chart", "5M Chart", "1M Chart"] / dst

                const chartsPayload = chartsRaw.map((obj, idx) => ({
                    slot: reqCharts[idx] || null,     // info slot: "4H Chart", "15M Chart", ...
                    index: idx,
                    name: obj.name || `chart_${idx + 1}.png`,
                    data: obj.data                    // data URL base64
                }));

                const macroPayload = macroRaw.map((obj, idx) => ({
                    slot: null,                       // kalau nanti mau ditag "DXY", "VIX", dll bisa diisi
                    index: idx,
                    name: obj.name || `macro_${idx + 1}.png`,
                    data: obj.data
                }));

                const payload = {
                    wizard_version: "1.9.2",
                    pair: wizardState.pair,                    // "gold"/"nasdaq"
                    style: wizardState.style,                  // "intraday"/"swing"
                    analysis_mode: wizardState.style === "intraday"
                        ? "INTRADAY"
                        : "SWING",
                    screenshot_counts: {
                        charts: chartsPayload.length,
                        macro: macroPayload.length
                    },
                    screenshots: {
                        charts: chartsPayload,
                        macro: macroPayload
                    }
                };

                // üîç Step 1: cek dulu di console
                console.log("[FW] payload to router:", payload);

                let jsonObj = null;

                try {
                    const resp = await fetch(WORKER_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (!resp.ok) throw new Error("Worker error " + resp.status);
                    jsonObj = await resp.json();
                } catch (err) {
                    console.warn("Worker error, fallback ke dummy-response.json:", err);
                    alert("Worker gagal: " + err);   // sementara, biar kelihatan jelas
                    try {
                        const res = await fetch("./dummy-response.json", { cache: "no-store" });
                        if (!res.ok) throw new Error("dummy-response.json not found");
                        jsonObj = await res.json();
                    } catch (err2) {
                        console.warn("Gagal load dummy-response.json:", err2);
                        showWarning("Gagal mengambil rekomendasi dari server.");
                        return;
                    }
                }

                renderAnalysisBubble(jsonObj);
                enableComposer();

                const b = addAssistantText(
                    "Apakah anda ingin melakukan trading ini? (akan disimpan ke pair story)"
                );
                addQuickReplies(b, [
                    { label: "Ya, lakukan & simpan", onClick: () => acceptTrade(true, jsonObj) },
                    { label: "Tidak", onClick: () => acceptTrade(false, jsonObj) }
                ]);
            }

            function acceptTrade(isYes, jsonObj) {
                wizardState.acceptedTrade = isYes;
                addUserText(isYes ? "Ya, lakukan." : "Tidak.");

                if (isYes) {
                    console.log("SAVE TO PAIR STORY:", jsonObj);
                    addAssistantText("‚úÖ Oke, rencana trading disimpan ke Pair Story kamu. Semoga eksekusinya lancar!");
                } else {
                    addAssistantText("üëç Siap. Tidak disimpan. Kalau mau analisa ulang, refresh halaman atau mulai wizard lagi.");
                }

                const b = addAssistantText("Mau mulai analisa baru?");
                addQuickReplies(b, [
                    { label: "Mulai lagi", onClick: () => resetAll() }
                ]);
            }

            function resetAll() {
                addUserText("Mulai lagi.");

                wizardState = { pair: null, style: null, charts: [], macro: [], acceptedTrade: null };

                // bersihkan staging di localStorage
                localStorage.removeItem(STORAGE_KEYS.charts);
                localStorage.removeItem(STORAGE_KEYS.macro);

                disableComposer();
                step1_pair();
            }


            // ---------------------------
            // Init chat
            // ---------------------------
            disableComposer();

            // bubble teks
            addAssistantText('<p>Daftar untuk medapatkan full access, <a href="">login</a> sekarang!</p>');

            // bubble sticker avatar tepat di bawahnya
            const stickerBubble = addMessage(
                "assistant",
                '<img src="img/avatar.png" alt="Avatar" />'
            );
            stickerBubble.addClass("sticker-bubble my-2");

            step1_pair();

        });
    </script>
</body>

</html>