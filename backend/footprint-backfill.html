<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Backfill Monitor â€” LiveTrade</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            padding: 24px;
            background-color: #f8f9fa;
        }

        .status-badge {
            text-transform: uppercase;
            font-weight: 600;
        }

        .slot-pill {
            display: inline-block;
            padding: .15rem .5rem;
            border-radius: 999px;
            font-size: .75rem;
            font-weight: 600;
        }

        .pill-ok {
            background: #e7f7ee;
            border: 1px solid #19875450;
            color: #198754;
        }

        .pill-fail {
            background: #fdecea;
            border: 1px solid #dc354550;
            color: #dc3545;
        }

        .pill-yield {
            background: #fff7e6;
            border: 1px solid #fd7e1450;
            color: #fd7e14;
        }

        .pill-run {
            background: #e7f0ff;
            border: 1px solid #0d6efd50;
            color: #0d6efd;
        }

        .card-stat {
            transition: transform 0.2s;
        }

        .card-stat:hover {
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h4 mb-0 fw-bold text-primary"><i class="fa-solid fa-server me-2"></i>Backfill Command Center
                </h1>
                <p class="text-muted small mb-0">LiveTrade Warmup & Atomic Swap Monitor</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <span id="last-updated" class="text-muted small me-2">Updated: -</span>
                <button id="btn-refresh" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-rotate me-1"></i>
                    Refresh</button>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card card-stat shadow-sm border-0 bg-primary text-white h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 opacity-75 small text-uppercase">Active Jobs</h6>
                        <h2 class="card-title fw-bold mb-0 display-6" id="kpi-active">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-stat shadow-sm border-0 h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted small text-uppercase">Completed</h6>
                        <h2 class="card-title fw-bold mb-0 text-success display-6" id="kpi-completed">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-stat shadow-sm border-0 h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted small text-uppercase">Yield Events</h6>
                        <h2 class="card-title fw-bold mb-0 text-warning display-6" id="kpi-yields">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-stat shadow-sm border-0 h-100">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted small text-uppercase">Failed</h6>
                        <h2 class="card-title fw-bold mb-0 text-danger display-6" id="kpi-failed">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold">Active Backfill Hours (Jan 9, 2026)</h6>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Hour</th>
                            <th>Engine</th>
                            <th>Status</th>
                            <th>Progress</th>
                            <th>Elapsed</th>
                            <th>Last Activity</th>
                        </tr>
                    </thead>
                    <tbody id="grid-body">
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Logs Console -->
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-2">
                <small class="fw-bold font-monospace">SYSTEM LOGS (Last 50)</small>
                <span class="badge bg-secondary">LIVE</span>
            </div>
            <div class="card-body bg-black p-0">
                <div style="height: 300px; overflow-y: auto;" class="p-3 font-monospace small text-light">
                    <table class="table table-dark table-sm table-borderless mb-0">
                        <tbody id="log-body">
                            <!-- Logs injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {

            // Mock Data Generator for Design Review
            function generateMockData() {
                const jobs = [
                    { hour: '02', engine: 'BACKFILL_ENGINE_3', status: 'PROCESSING_WARMUP', processed: 742, total: 748, elapsed: 4200, last_ts: '13:45:00' },
                    { hour: '04', engine: 'BACKFILL_ENGINE_5', status: 'PROCESSING_WARMUP', processed: 1376, total: 748, elapsed: 3800, last_ts: '13:45:10' },
                    { hour: '09', engine: 'BACKFILL_ENGINE_3', status: 'YIELDING', processed: 130, total: 748, elapsed: 720, last_ts: '13:45:20' },
                    { hour: '06', engine: 'BACKFILL_ENGINE_7', status: 'COMPLETED', processed: 0, total: 0, elapsed: 45, last_ts: '12:21:15' },
                ];

                render(jobs);
            }

            function render(jobs) {
                const $tbody = $('#grid-body');
                $tbody.empty();

                let active = 0, completed = 0, failed = 0, yields = 0;

                jobs.forEach(job => {
                    // KPIs
                    if (job.status === 'COMPLETED') completed++;
                    else if (job.status === 'FAILED') failed++;
                    else if (job.status === 'YIELDING') { active++; yields++; }
                    else active++;

                    // Status Pill
                    let pillClass = 'pill-run';
                    if (job.status === 'COMPLETED') pillClass = 'pill-ok';
                    else if (job.status === 'FAILED') pillClass = 'pill-fail';
                    else if (job.status === 'YIELDING') pillClass = 'pill-yield';

                    // Progress Bar
                    const pct = job.total > 0 ? Math.min(100, Math.round((job.processed / job.total) * 100)) : 100;
                    const barColor = job.status === 'COMPLETED' ? 'bg-success' : (job.status === 'YIELDING' ? 'bg-warning' : 'bg-primary');

                    const row = `
                    <tr>
                        <td class="ps-4 fw-bold font-monospace">${job.hour}:00</td>
                        <td class="small text-muted">${job.engine}</td>
                        <td><span class="slot-pill ${pillClass}">${job.status}</span></td>
                        <td style="width: 30%;">
                            <div class="d-flex justify-content-between small mb-1">
                                <span>${job.processed} / ${job.total || '?'}</span>
                                <span class="fw-bold">${pct}%</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar ${barColor}" style="width: ${pct}%"></div>
                            </div>
                        </td>
                        <td class="font-monospace small">${(job.elapsed / 60).toFixed(1)}m</td>
                        <td class="text-muted small">${job.last_ts}</td>
                    </tr>
                `;
                    $tbody.append(row);
                });

                // Update KPIs
                $('#kpi-active').text(active);
                $('#kpi-completed').text(completed);
                $('#kpi-yields').text(yields);
                $('#kpi-failed').text(failed);

                $('#last-updated').text('Updated: ' + new Date().toLocaleTimeString());
            }

            // Mock Run
            generateMockData();

            // Real fetch placeholder
            $('#btn-refresh').click(() => {
                // fetch('/admin/backfill-logs').then(...)
                $('#last-updated').text('Refreshing...');
                setTimeout(generateMockData, 500);
            });
        });
    </script>
</body>

</html>