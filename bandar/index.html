<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ffffff" />
  <!-- keep a single manifest file reference -->
  <link rel="manifest" href="../site.webmanifest">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="../site.webmanifest">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <title>BBBANDAR SSSAHAM - Bandar Saham Kolektif Untuk Para Ritel Saham</title>
  <!-- Open Graph for WhatsApp / Link Previews -->
  <meta property="og:title" content="SSSAHAM â€” Bandar Saham Kolektif">
  <meta property="og:description"
    content="Pantau rekomendasi saham berbasis data pergerakan Broker Summary, Foreign inflow dan Outflow.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://bandar.sssaham.com/">
  <meta property="og:site_name" content="Broker Summary Saham Indonesia">
  <meta property="og:image" content="https://contoh-domain-kamu.xyz/og/sssaham-1200x630.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">

  <!-- Optional: Twitter (aman buat platform lain) -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="SSSAHAM â€” Bandar Saham Kolektif">
  <meta name="twitter:description"
    content="Pantau rekomendasi saham berbasis data: skor, probabilitas Markov, dan feed real-time.">
  <meta name="twitter:image" content="https://contoh-domain-kamu.xyz/og/sssaham-1200x630.jpg">

  <!-- App CSS -->
  <link rel="stylesheet" href="../theme.css?v=1.4">
  <style>
    /* file drop box used by the wizard */
    .file-drop-box{
      border: 1px dashed rgba(108,117,125,.4);
      border-radius: 10px;
      padding: 18px;
      text-align: center;
      background: #f8f9fa;
      cursor: pointer;
      /* keep a stable box height so preview images don't push content up/down */
      min-height: 20rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .file-drop-box:hover{ background: #f1f3f5; }
    .file-drop-box .cloud-icon{ color: #6c757d; font-size: 36px; }
    .file-drop-box .hint{ color: #6c757d; font-size: 0.9rem; margin-top: 8px; }
  .file-drop-box img.preview-thumb{ max-height: 140px; width: auto; display:block; margin: 8px auto 0; object-fit: contain; }
  /* subtle drag-over state */
  .file-drop-box.drag-over{ background:#eef6ff; border-color: rgba(13,110,253,.4); }
  </style>
</head>

<body>
  <div id="app" class="container">
    <!-- halaman home -->
    <section id="home-page">
      <div class="this-page border-bottom d-flex flex-row align-items-center justify-content-between p-4 py-3 mt-3">
        <h2 class="d-flex text-center fs-6" style="font-weight: 400;">ðŸ‘‹ Hi, Quant Trader!</h2>
        <a href="performance-report.html" id="performance-report" class="d-flex btn btn-lg p-0"><i
            class="fa-solid  fa fa-pie-chart" style="color: dodgerblue;"></i></a>
      </div>
      <div class="this-page my-3 p-2" style="background-color: #e8ecec !important;">
        <small class="d-block text-center mb-0">Bagaimana analisa transaksi saham bekerja?<br /> <a
            href="about-us.html" style="color: dodgerblue;">Pelajari Lebih Lanjut</a></small>
      </div>

      <!-- Upload Wizard -->
      <div id="tape-reading-wizard" class="this-page p-4 mb-4">
        <h5 class="mb-3 text-center fw-bold">
          Mulai Analisa Pergerakan Bandar
        </h5>
        <div id="tape-reading-wizard-wrap"></div>
        <div id="tape-reading-wizard-alert-wrap" class="mt-2" aria-live="polite"></div>
      </div>

      <!-- Wizard Confirmation -->
      <div id="tape-reading-confirmation" class="this-page d-none p-4 mb-4">
        <h5 class="mb-3 text-center fw-bold">
          Mulai Analisa Pergerakan Bandar
        </h5>
        <div id="tape-reading-confirmation-wrap"></div>
      </div>

      <!-- Rekomendasi tape reading -->
      <div class="this-page d-flex flex-column align-items-center border-bottom p-4 mb-4">
        <h1 class="text-center mb-3 fs-5 fw-bold">Latest Tape Reading Analysis</h1>
        <div class="text-muted small">Updated in â€”</div>
        <div id="picksOuter" class="picks-outer mt-3">
          <div id="top-picks" class="picks-grid">

            <div class="pick-card">
              <div class="pick-head">
                <span class="pick-badge"><i class="fa-solid fa-chart-line"></i> Top Pick</span>
                <h4 class="pick-ticker">NFCX.JK</h4>
              </div>
              <div class="pick-score">Score: <b>10.0</b> / 10</div>
              <div class="score-rail">
                <div class="score-fill" style="width:100%;background:#43A047"></div>
              </div>
              <ul class="pick-bullets"></ul>
              <button class="d-none btn btn-primary pick-cta">LIHAT ANALISA</button>
            </div>

            <div class="pick-card">
              <div class="pick-head">
                <span class="pick-badge"><i class="fa-solid fa-chart-line"></i> Top Pick</span>
                <h4 class="pick-ticker">UNVR.JK</h4>
              </div>
              <div class="pick-score">Score: <b>10.0</b> / 10</div>
              <div class="score-rail">
                <div class="score-fill" style="width:100%;background:#43A047"></div>
              </div>
              <ul class="pick-bullets"></ul>
              <button class="d-none btn btn-primary pick-cta">LIHAT ANALISA</button>
            </div>

            <div class="pick-card">
              <div class="pick-head">
                <span class="pick-badge"><i class="fa-solid fa-chart-line"></i> Top Pick</span>
                <h4 class="pick-ticker">UNVR.JK</h4>
              </div>
              <div class="pick-score">Score: <b>10.0</b> / 10</div>
              <div class="score-rail">
                <div class="score-fill" style="width:100%;background:#43A047"></div>
              </div>
              <ul class="pick-bullets"></ul>
              <button class="d-none btn btn-primary pick-cta">LIHAT ANALISA</button>
            </div>

          </div>
          <small id="top-picks-note" class="text-muted d-block text-center mt-2">
            Ditentukan dari skor inflow, outflow, dan karakter.
          </small>
        </div>
      </div>

    </section>

  </div>

  <!-- jQuery INIT -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap Bundle JS INIT -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- App JS -->

  <!-- Optional: Argon2 WASM for stronger client-side KDF. We load it if available and
     prefer it over PBKDF2 for deriveKey. Loading it is optional; code falls back
     to PBKDF2 when the library isn't present or fails to load. -->
  <script src="https://cdn.jsdelivr.net/npm/argon2-browser/dist/argon2.min.js"></script>

  <!-- Optional JS -->
  <script>
    function showAlert() {
      $('body').append('<div class="alert alert-success mt-3 text-center" role="alert">jQuery berhasil dijalankan!</div>');
    }
  </script>
  <script>
    $(document).ready(function () {
      const steps = [
        "Upload Screenshot 1 Hari Kebelakang",
        "Upload Screenshot 2 Hari Kebelakang",
        "Upload Screenshot 3 Hari Kebelakang",
        "Upload Screenshot 4 Hari Kebelakang",
        "Upload Screenshot 5 Hari Kebelakang",
        "Upload Screenshot 2 Minggu To Date",
        "Upload Screenshot 4 Weeks To Date",
        "Upload Screenshot 15 Min Chart",
        "Upload Screenshot 4 Hour Chart",
        "Upload Screenshot Weekly Chart",
      ];

      let currentStep = 0;
      let db;
      // in-memory maps for immediate validation and preview
      const uploadedSteps = {};
      const uploadedImages = {}; // { step: dataURL }

      // Reset IndexedDB on every page load/refresh so temporary images don't persist.
      // This keeps the wizard stateless between sessions (useful for debugging/testing).
      function openImageDB() {
        const request = indexedDB.open("ImageWizardDB", 1);
        request.onupgradeneeded = function (event) {
          db = event.target.result;
          if (!db.objectStoreNames.contains("images")) {
            const store = db.createObjectStore("images", { keyPath: "id", autoIncrement: true });
            // create index for faster per-step queries
            try {
              store.createIndex('step', 'step', { unique: false });
            } catch (e) {
              console.warn('Could not create index step:', e);
            }
          }
        };
        request.onsuccess = function (event) {
          db = event.target.result;
          console.log('ImageWizardDB opened (fresh)');
        };
        request.onerror = function (event) {
          console.error("IndexedDB error:", event.target.errorCode);
        };
      }

      // Delete the DB on load. When deletion completes (or fails), open a fresh one.
      const deleteReq = indexedDB.deleteDatabase("ImageWizardDB");
      deleteReq.onblocked = function () {
        console.warn('deleteDatabase blocked; continuing to open DB');
        openImageDB();
      };
      deleteReq.onerror = function (e) {
        console.warn('deleteDatabase failed, opening DB anyway', e);
        openImageDB();
      };
      deleteReq.onsuccess = function () {
        console.log('ImageWizardDB deleted on page load');
        openImageDB();
      };

      function saveImageToDB(file, step) {
        // optimistic: mark uploaded in-memory immediately so validation is synchronous
        uploadedSteps[step] = true;

        const reader = new FileReader();
        reader.onload = function (event) {
          // keep a quick preview copy in-memory so confirmation can render instantly
          uploadedImages[step] = event.target.result;

          try {
            const transaction = db.transaction(["images"], "readwrite");
            const store = transaction.objectStore("images");
            store.add({ step: step, image: event.target.result });
            console.log("Image saved for step:", step);
          } catch (err) {
            // DB might not be ready yet; keep the in-memory flag so UX works
            console.warn('IndexedDB not ready yet, saved in-memory flag for step', step, err);
          }
        };
        reader.readAsDataURL(file); // Convert file to Base64
      }

      function showWarning(message) {
        const warningDiv = $("<div class='alert alert-danger mt-2' role='alert' aria-live='polite'></div>").text(message);
        // Ensure the dedicated alert container exists and is outside the main wizard content.
        let alertContainer = $("#tape-reading-wizard-alert-wrap");
        if (!alertContainer.length) {
          // If it's missing for some reason (timing or markup change), create it
          // as a sibling after the wizard wrap so alerts don't get cleared by
          // wizardWrap.empty().
          const created = $("<div id='tape-reading-wizard-alert-wrap' class='mt-2' aria-live='polite'></div>");
          const wizardWrap = $("#tape-reading-wizard-wrap");
          if (wizardWrap.length) {
            wizardWrap.after(created);
          } else {
            // worst-case: append to tape-reading-wizard
            $("#tape-reading-wizard").append(created);
          }
          alertContainer = $("#tape-reading-wizard-alert-wrap");
        }

        // put newest alerts at top and limit to 3 visible alerts
        alertContainer.prepend(warningDiv);
        const alerts = alertContainer.children('.alert');
        if (alerts.length > 3) {
          alerts.last().remove();
        }

        // auto-dismiss
        setTimeout(() => warningDiv.fadeOut(() => warningDiv.remove()), 3000);
      }

      function checkImageUploaded(callback) {
        // fast path: if user uploaded in this session, allow immediately
        if (uploadedSteps[currentStep]) {
          return callback();
        }

        // if DB not ready yet, block and ask user to upload (prevents false positives)
        if (!db) {
          showWarning("Please upload an image before proceeding to the next step.");
          return;
        }

        const transaction = db.transaction(["images"], "readonly");
        const store = transaction.objectStore("images");

        // Try to use an index if it exists (faster). If index is not found
        // (DB created before index existed), fall back to getAll() and filter.
        try {
          const index = store.index("step");
          const request = index.getAll(currentStep);
          request.onsuccess = function () {
            if (!request.result || request.result.length === 0) {
              showWarning("Please upload an image before proceeding to the next step.");
            } else {
              callback();
            }
          };
          request.onerror = function () {
            showWarning("Error checking uploaded images. Please try again.");
          };
        } catch (err) {
          // Index doesn't exist. Read all and filter by step.
          const requestAll = store.getAll();
          requestAll.onsuccess = function () {
            const results = requestAll.result || [];
            const found = results.some(r => r && r.step === currentStep);
            if (!found) {
              showWarning("Please upload an image before proceeding to the next step.");
            } else {
              callback();
            }
          };
          requestAll.onerror = function () {
            showWarning("Error checking uploaded images. Please try again.");
          };
        }
      }

      function renderStep() {
        const wizardWrap = $("#tape-reading-wizard-wrap");
        wizardWrap.empty();

        const stepCounter = $(`<div class='text-center text-muted mb-1'><span>Step (${currentStep + 1}/${steps.length})</span></div>`);
        const stepTitle = $(`<h6 class='text-center mb-3 text-muted'>${steps[currentStep]}</h6>`);

        // custom file drop box (hidden native input + visible box with cloud icon)
        const nativeFileInput = $("<input type='file' accept='image/*' capture style='display:none'>");
        const fileBox = $(`<div class='file-drop-box my-4' tabindex='0'>
          <div class='cloud-wrap'>
            <i class='fa-solid fa-cloud-arrow-up cloud-icon' aria-hidden='true'></i>
          </div>
          <div class='hint'>Tap or drop image di sini<br/><small class='text-muted'>Accepts images only</small></div>
        </div>`);
        // preview element (will be appended to fileBox when image selected)
        const previewImg = $("<img class='preview-thumb d-none' alt='preview'>");
        fileBox.append(previewImg);
        const nextButton = $("<button class='btn btn-primary'>Next</button>");
        const prevButton = $("<button class='btn btn-secondary me-2'>Previous</button>");
        const finishButton = $("<button class='btn btn-success'>Finish</button>");

        // wire native input change to our save + preview
        nativeFileInput.on("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            if (!file.type.startsWith("image/")) {
              showWarning("Please upload a valid image file.");
              return;
            }
            // show preview
            const reader = new FileReader();
            reader.onload = function (ev) {
              previewImg.attr('src', ev.target.result).removeClass('d-none');
              saveImageToDB(file, currentStep);
            };
            reader.readAsDataURL(file);
          } else {
            showWarning("No file selected. Please upload an image.");
          }
        });

        // click or keypress on box opens native file picker
        fileBox.on('click keypress', function (e) {
          if (e.type === 'click' || (e.type === 'keypress' && (e.key === 'Enter' || e.key === ' '))) {
            nativeFileInput.trigger('click');
          }
        });

        // support drop files
        fileBox.on('dragover', function (e) { e.preventDefault(); e.originalEvent.dataTransfer.dropEffect = 'copy'; $(this).addClass('drag-over'); });
        fileBox.on('dragleave drop', function (e) { e.preventDefault(); $(this).removeClass('drag-over'); });
        fileBox.on('drop', function (e) {
          e.preventDefault();
          const dt = (e.originalEvent || e).dataTransfer;
          if (!dt || !dt.files || dt.files.length === 0) return;
          const file = dt.files[0];
          if (!file.type.startsWith('image/')) { showWarning('Please upload a valid image file.'); return; }
          const reader = new FileReader();
          reader.onload = function (ev) {
            previewImg.attr('src', ev.target.result).removeClass('d-none');
            saveImageToDB(file, currentStep);
          };
          reader.readAsDataURL(file);
        });

        // append native input and fileBox to wizard
        wizardWrap.append(stepCounter, stepTitle, nativeFileInput, fileBox);

        // Handle paste event (use namespaced handler so we don't attach duplicates)
        $(document).off('paste.wizard').on('paste.wizard', function (e) {
          const items = (e.originalEvent || e).clipboardData.items;
          let imagePasted = false;
          for (const item of items) {
            if (item.kind === "file" && item.type.startsWith("image/")) {
              const file = item.getAsFile();
              saveImageToDB(file, currentStep);
              imagePasted = true;
            }
          }
          if (!imagePasted) {
            showWarning("Please paste a valid image file.");
          }
        });

        nextButton.on("click", function () {
          checkImageUploaded(() => {
            if (currentStep < steps.length - 1) {
              currentStep++;
              renderStep();
            }
          });
        });

        prevButton.on("click", function () {
          if (currentStep > 0) {
            currentStep--;
            renderStep();
          }
        });

        finishButton.on("click", function () {
          // Instead of immediately sending, show confirmation view for user review.
          showConfirmation();
        });

  // Note: `nativeFileInput` and `fileBox` were already appended above.
  // Removing the erroneous append that referenced an undefined `fileInput`
  // which caused a ReferenceError and prevented the action buttons from
  // being rendered.
        // action buttons: Previous / Next (50% / 50%)
        const actionsRow = $("<div class='d-flex gap-2 mt-2'></div>");
        // make buttons expand equally
        prevButton.addClass('flex-fill');
        nextButton.addClass('flex-fill');
        finishButton.addClass('flex-fill');

        if (currentStep > 0 && currentStep < steps.length - 1) {
          actionsRow.append(prevButton, nextButton);
        } else if (currentStep === 0 && currentStep < steps.length - 1) {
          // no previous: add placeholder to keep spacing, next on right
          const leftPlaceholder = $("<div class='flex-fill'></div>");
          actionsRow.append(leftPlaceholder, nextButton);
        } else if (currentStep > 0 && currentStep === steps.length - 1) {
          // last step: show previous and finish equally
          actionsRow.append(prevButton, finishButton);
        } else if (currentStep === 0 && currentStep === steps.length - 1) {
          // single-step edge-case: show finish full width (use two halves, right one active)
          const leftPlaceholder = $("<div class='flex-fill'></div>");
          actionsRow.append(leftPlaceholder, finishButton);
        }

  wizardWrap.append(actionsRow);
      }

      // Show confirmation view with vertical list of images for user verification
      function showConfirmation() {
        const confWrap = $("#tape-reading-confirmation-wrap");
        confWrap.empty();

        // collect images in order of steps
        const imagesToShow = [];

        // prefer in-memory uploadedImages, fall back to DB if missing
        for (let i = 0; i < steps.length; i++) {
          if (uploadedImages[i]) {
            imagesToShow.push({ step: i, data: uploadedImages[i] });
          }
        }

        if (imagesToShow.length < steps.length) {
          // try reading from DB for any missing images
          if (db) {
            const transaction = db.transaction(["images"], "readonly");
            const store = transaction.objectStore("images");
            const req = store.getAll();
            req.onsuccess = function () {
              const all = req.result || [];
              // map by step if not already included
              for (const item of all) {
                if (item && typeof item.step !== 'undefined' && !uploadedImages[item.step]) {
                  uploadedImages[item.step] = item.image;
                  imagesToShow.push({ step: item.step, data: item.image });
                }
              }
              renderConfirmationList(confWrap, imagesToShow);
            };
            req.onerror = function () {
              renderConfirmationList(confWrap, imagesToShow);
            };
            return;
          }
        }

        renderConfirmationList(confWrap, imagesToShow);
      }

      function renderConfirmationList(confWrap, images) {
        // sort by step
        images.sort((a, b) => a.step - b.step);

        if (images.length === 0) {
          confWrap.append($('<div class="text-center text-muted">Belum ada gambar untuk ditampilkan.</div>'));
        } else {
          for (const it of images) {
            const item = $("<div class='mb-3'></div>");
            item.append($(`<div class='small text-muted mb-1'>Step ${it.step + 1}: ${steps[it.step]}</div>`));
            const img = $(`<img src="${it.data}" class="img-fluid" style="max-height:400px; display:block; width:100%; object-fit:contain;"/>`);
            item.append(img);
            confWrap.append(item);
          }
        }

        // action buttons: Back and Upload
        const actions = $("<div class='d-flex justify-content-between mt-3'></div>");
        const backBtn = $("<button class='btn btn-secondary'>Kembali ke Upload</button>");
        const uploadBtn = $("<button class='btn btn-success'>Kirim Semua</button>");

        backBtn.on('click', function () {
          // show upload wizard again
          $("#tape-reading-confirmation").addClass('d-none');
          $("#tape-reading-wizard").removeClass('d-none');
          // keep currentStep on the first missing step or last step index
          // find first step without uploadedImages
          for (let i = 0; i < steps.length; i++) {
            if (!uploadedImages[i]) {
              currentStep = i;
              renderStep();
              return;
            }
          }
          // all have images, go to last
          currentStep = steps.length - 1;
          renderStep();
        });

        uploadBtn.on('click', function () {
          uploadAllImages();
        });

        actions.append(backBtn, uploadBtn);
        confWrap.append(actions);

        // show confirmation and hide wizard
        $("#tape-reading-wizard").addClass('d-none');
        $("#tape-reading-confirmation").removeClass('d-none');
        // scroll to top of confirmation on mobile
        window.scrollTo({ top: $("#tape-reading-confirmation").offset().top, behavior: 'smooth' });
      }

      function uploadAllImages() {
        // collect images from uploadedImages in order
        const payload = [];
        for (let i = 0; i < steps.length; i++) {
          if (uploadedImages[i]) {
            payload.push({ step: i, image: uploadedImages[i] });
          }
        }

        if (payload.length === 0) {
          showWarning('Tidak ada gambar untuk dikirim.');
          return;
        }

        // Simulate upload (replace with real fetch to server endpoint)
        const sendingNotice = $("<div class='text-center mt-3'>Mengirim gambar...</div>");
        $("#tape-reading-confirmation-wrap").append(sendingNotice);

        setTimeout(() => {
          // pretend success
          sendingNotice.remove();
          alert('Semua gambar berhasil dikirim!');

          // clear DB and in-memory maps
          try {
            if (db) {
              const clearTransaction = db.transaction(["images"], "readwrite");
              const clearStore = clearTransaction.objectStore("images");
              clearStore.clear();
            }
          } catch (e) {
            console.warn('Could not clear IndexedDB after upload', e);
          }
          // reset in-memory
          for (const k in uploadedSteps) delete uploadedSteps[k];
          for (const k in uploadedImages) delete uploadedImages[k];

          // close confirmation and reset wizard to step 0
          $("#tape-reading-confirmation").addClass('d-none');
          $("#tape-reading-wizard").removeClass('d-none');
          currentStep = 0;
          renderStep();
        }, 900);
      }

      renderStep();
    });
  </script>
</body>

</html>