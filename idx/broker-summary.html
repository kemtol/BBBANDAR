<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#ffffff" />

    <title>SSSAHAM - Intraday Orderflow Scanner</title>

    <!-- (opsional) samain dengan index.html -->
    <!-- Manifest removed - file tidak ada -->
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">

    <!-- Bootstrap & Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" />

    <style>
        /* Biar konsisten dengan index.html / QQQUANTA */
        #app.container,
        .container,
        .chat-wrapper {
            max-width: 1200px;
            margin: 0 auto;
        }

        body {
            font-size: 1rem;
        }

        .navbar {
            background-color: #463CFF !important;
        }

        .navbar i.fa-chevron-left {
            font-size: 1rem;
            color: white;
        }

        .nav-title {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            transition: opacity 0.3s ease;
            opacity: 1;
        }

        .nav-title.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .page-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .card-swing {
            border-radius: 12px;
            border: none;
        }

        .card-swing-header {
            background: transparent;
            border-bottom: 1px solid rgba(148, 163, 184, 0.4);
            border-radius: 12px 12px 0 0;
            padding: 0.5rem 0.75rem;
        }

        .table-orderflow {
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .table-orderflow thead th {
            text-transform: uppercase;
            font-size: 0.9rem;
            color: #6b7280;
            border-bottom-color: #e5e7eb;
        }

        .table-orderflow tbody tr {
            cursor: pointer;
        }

        .table-orderflow tbody tr:hover {
            background-color: #f1f5f9;
        }

        .table-orderflow thead th.sortable {
            position: relative;
            padding-right: 14px;
            /* ruang untuk icon */
        }

        /* Mobile: Hide Buy/Sell/Net columns */
        @media (max-width: 767px) {
            .hide-mobile {
                display: none !important;
            }

            .broker-table-mobile {
                font-size: 0.85rem;
            }
        }

        .sort-icon {
            position: absolute;
            right: 2px;
            top: 50%;
            transform: translateY(-50%);
        }

        .sort-icon.active {
            opacity: 1;
        }



        .quadrant-badge {
            width: 18px;
            text-align: center;
            border-radius: 999px;
            font-size: 0.7rem;
            display: block;
            height: 18px;
            position: relative;
            left: 5px;
        }

        .stat-pill {
            font-size: 0.7rem;
            border-radius: 999px;
            padding: 2px 8px;
        }

        .quad-legend {
            font-size: 0.7rem;
            color: #6b7280;
        }

        @media (max-width: 576px) {
            .page-title {
                font-size: 0.95rem;
            }
        }

        /* Smart Sticky Header */
        .navbar {
            transition: transform 0.3s ease-in-out;
        }

        .navbar.hidden {
            transform: translateY(-100%);
        }

        /* Pull to Refresh Indicator */
        #pull-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, #f0f0f0 0%, transparent 100%);
            transform: translateY(-100%);
            transition: transform 0.2s;
            z-index: 1000;
            pointer-events: none;
        }

        #pull-indicator.pulling {
            transform: translateY(0);
        }

        #pull-indicator i {
            font-size: 1.5rem;
            color: #6b7280;
            transition: transform 0.2s;
        }

        #pull-indicator.ready i {
            transform: rotate(180deg);
        }

        /* Tab Styles */
        .nav-link {
            font-size: 0.8rem;
            font-weight: 700;
        }

        /* Search Panel */
        #search-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            background-color: #463CFF;
            z-index: 2000;
            transition: right 0.3s ease-in-out;
            padding: 20px;
            color: white;
        }

        #search-panel.open {
            right: 0;
        }

        @media (min-width: 768px) {
            #search-panel {
                width: 350px;
                box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            }
        }

        .search-input {
            background: white;
            border: none;
            border-radius: 8px;
            padding: 12px 15px;
            width: 100%;
            color: #333;
            font-weight: 600;
        }

        .search-history-item {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-history-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Responsive Chart Height */
        .chart-container-responsive {
            height: 50vh;
            width: 100%;
            position: relative;
            /* Critical for Chart.js resizing */
        }

        @media (orientation: portrait) {
            .chart-container-responsive {
                height: 30vh !important;
            }
        }

        .nav-title {
            font-size: 0.9rem !important;
        }
    </style>
</head>

<body>
    <!-- Pull to Refresh Indicator -->
    <div id="pull-indicator">
        <i class="fa-solid fa-arrow-down"></i>
        <span class="ms-2 small text-muted" id="pull-text">Tarik untuk refresh</span>
    </div>

    <!-- NAVBAR -->
    <nav class="navbar navbar-light sticky-top border-bottom bg-white">
        <div class="container d-flex align-items-center py-2" style="max-width: 1200px;position: relative;">
            <a href="https://buy.sssaham.com" class="d-flex align-items-center text-decoration-none me-2">
                <i class="fa-solid fa-chevron-left me-1"></i>
                <span class="small d-none">Bandar Radar</span>
            </a>
            <div class="flex-grow-1 text-center">
                <span class="fw-bold nav-title" id="header-title">Broker Summary</span>
            </div>
            <div style="width:72px;" class="text-end">
                <i class="fa-solid fa-magnifying-glass text-white" style="cursor: pointer; font-size: 1rem;"
                    onclick="toggleSearch()"></i>
            </div>
        </div>
    </nav>

    <!-- SEARCH PANEL -->
    <div id="search-panel">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0 fw-bold">Cari Emiten</h5>
            <i class="fa-solid fa-xmark fa-lg" style="cursor: pointer;" onclick="toggleSearch()"></i>
        </div>

        <div class="mb-4">
            <input type="text" id="search-input" class="search-input" placeholder="Masukkan Kode (e.g. BBRI)"
                autocomplete="off">
        </div>

        <div>
            <p class="small opacity-75 mb-2 fw-bold">RIWAYAT PENCARIAN</p>
            <div id="search-history-list">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <div id="loading-indicator" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="small text-muted mt-2">Memuat data...</p>
    </div>

    <div id="app" class="container mb-3" style="display:none;">

        <!-- VIEW 1: INDEX (DAFTAR EMITEN) -->
        <div id="index-view">
            <h5 class="mb-3 mt-3">Loading..</h5>
            <div class="card card-swing">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 table-orderflow align-middle">
                        <thead>
                            <tr>
                                <th class="text-center">#</th>
                                <th>Kode</th>
                                <th class="text-center">7D</th>
                                <th class="text-center">14D</th>
                                <th class="text-center">30D</th>
                                <th class="text-center">90D</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-index">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW 2: DETAIL DASHBOARD -->
        <div id="detail-view" style="display:none;">

            <!-- TABS -->
            <ul class="nav nav-tabs mb-3 mt-3" id="detailTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-pane"
                        type="button" role="tab">Summary</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit-pane"
                        type="button" role="tab">Audit Trail</button>
                </li>
            </ul>

            <div class="tab-content" id="detailTabContent">
                <!-- TAB: SUMMARY -->
                <div class="tab-pane fade show active" id="summary-pane" role="tabpanel">
                    <!-- CHART -->
                    <div class="mb-1">
                        <div class="chart-container-responsive">
                            <canvas id="detailChart"></canvas>
                        </div>
                    </div>

                    <!-- FILTER RANGE MOVED TO CARD HEADER -->

                    <!-- BROKER TABLE -->
                    <div class="card card-swing mb-4">
                        <div class="card-header bg-white border-bottom-0 py-3">
                            <!-- Top Row: Legend Centered (Moved Up) -->
                            <div class="text-center small mb-2 pb-2">
                                <span class="fw-bold text-success me-2">● Foreign Fund</span>
                                <span class="fw-bold text-danger me-2">● Retail</span>
                                <span class="fw-bold text-primary">● Local Fund</span>
                            </div>

                            <!-- Bottom Row: Controls -->
                            <div class="d-flex justify-content-between align-items-center">
                                <!-- Dates Group + Apply (Left) -->
                                <div class="d-flex gap-2 align-items-center">
                                    <div class="d-flex gap-1">
                                        <input type="date" id="date-from" class="form-control form-control-sm"
                                            style="max-width: 105px;" />
                                        <input type="date" id="date-to" class="form-control form-control-sm"
                                            style="max-width: 105px;" />
                                    </div>
                                    <button id="btn-apply-range" class="btn btn-sm btn-primary">Apply</button>
                                </div>

                                <!-- Action Group (Right) - Net Only -->
                                <div>
                                    <div class="form-check form-switch mb-0 d-flex align-items-center gap-1 ms-1">
                                        <input class="form-check-input my-0" type="checkbox" id="toggleNet" checked>
                                        <label class="form-check-label small mb-0" for="toggleNet">Net</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body" id="broker-table-container">
                            <p class="text-muted small">Detail metrics will appear here based on R2 data.</p>
                        </div>
                    </div>
                </div>

                <!-- TAB: AUDIT TRAIL -->
                <div class="tab-pane fade" id="audit-pane" role="tabpanel">
                    <div class="card card-swing">
                        <div class="card-body">
                            <h6 class="border-bottom pb-2 mb-3">Daily Foreign Flow</h6>
                            <div id="audit-trail-list">
                                <p class="text-muted small">Audit trail will be populated here...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <!-- MAIN LOGIC -->
    <script>
        const WORKER_BASE_URL = "https://broksum-scrapper.mkemalw.workers.dev";
        const urlParams = new URLSearchParams(window.location.search);
        const emitenParam = urlParams.get('emiten');
        const startParam = urlParams.get('start');
        const endParam = urlParams.get('end');
        const netParam = urlParams.get('net'); // 'true' or 'false'
        let brokersMap = {};

        $(document).ready(function () {
            // Fetch Brokers Mapping
            fetch(`${WORKER_BASE_URL}/brokers`)
                .then(r => r.json())
                .then(d => {
                    if (d.brokers) brokersMap = d.brokers;
                })
                .catch(e => console.error("Error fetching brokers:", e))
                .finally(() => {
                    // Initialize after fetch attempt (or parallel, but we want tooltips to work)
                    if (emitenParam) {
                        initDetailMode(emitenParam);
                    } else {
                        initIndexMode();
                    }
                });
            // Search Logic Initialization
            initSearch();
        });

        // =========================================
        // SEARCH FUNCTIONALITY
        // =========================================
        function toggleSearch() {
            const panel = document.getElementById('search-panel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                document.getElementById('search-input').focus();
                loadSearchHistory();
            }
        }

        function initSearch() {
            const input = document.getElementById('search-input');
            input.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    const symbol = this.value.toUpperCase().trim();
                    if (symbol) {
                        saveSearchHistory(symbol);
                        window.location.href = `?emiten=${symbol}`;
                    }
                }
            });
        }

        function saveSearchHistory(symbol) {
            let history = JSON.parse(localStorage.getItem('search_history') || '[]');
            // Remove if exists
            history = history.filter(h => h !== symbol);
            // Add to top
            history.unshift(symbol);
            // Limit to 10
            if (history.length > 10) history.pop();
            localStorage.setItem('search_history', JSON.stringify(history));
        }

        function loadSearchHistory() {
            const history = JSON.parse(localStorage.getItem('search_history') || '[]');
            const list = document.getElementById('search-history-list');
            list.innerHTML = '';

            if (history.length === 0) {
                list.innerHTML = '<p class="small opacity-50 fst-italic">Belum ada riwayat.</p>';
                return;
            }

            history.forEach(sym => {
                const div = document.createElement('div');
                div.className = 'search-history-item';
                div.innerHTML = `
                    <span class="fw-bold">${sym}</span>
                    <i class="fa-solid fa-chevron-right small opacity-50"></i>
                `;
                div.onclick = () => {
                    saveSearchHistory(sym); // update timestamp/order
                    window.location.href = `?emiten=${sym}`;
                };
                list.appendChild(div);
            });
        }

        // =========================================
        // SMART STICKY HEADER & PULL TO REFRESH
        // =========================================
        let lastScrollY = 0;
        let ticking = false;
        const navbar = document.querySelector('.navbar');
        const viewportHeight = window.innerHeight;

        window.addEventListener('scroll', () => {
            if (!ticking) {
                window.requestAnimationFrame(() => {
                    const currentScrollY = window.scrollY;
                    const scrollDirection = currentScrollY > lastScrollY ? 'down' : 'up';

                    // Only apply smart behavior after 25% of total scroll height
                    const threshold = document.documentElement.scrollHeight * 0.25;

                    if (currentScrollY > threshold) {
                        if (scrollDirection === 'down') {
                            navbar.classList.add('hidden');
                        } else {
                            navbar.classList.remove('hidden');
                        }
                    } else {
                        // Always show when near top (0-10%)
                        navbar.classList.remove('hidden');
                    }

                    lastScrollY = currentScrollY;
                    ticking = false;
                });
                ticking = true;
            }
        });

        // Pull to Refresh
        let touchStartY = 0;
        let isPulling = false;
        const pullIndicator = document.getElementById('pull-indicator');
        const pullText = document.getElementById('pull-text');
        const PULL_THRESHOLD = 80;

        document.addEventListener('touchstart', (e) => {
            if (window.scrollY === 0) {
                touchStartY = e.touches[0].clientY;
                isPulling = true;
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (!isPulling || window.scrollY > 0) return;

            const touchY = e.touches[0].clientY;
            const pullDistance = touchY - touchStartY;

            if (pullDistance > 0 && pullDistance < 150) {
                pullIndicator.classList.add('pulling');

                if (pullDistance > PULL_THRESHOLD) {
                    pullIndicator.classList.add('ready');
                    pullText.textContent = 'Lepas untuk refresh';
                } else {
                    pullIndicator.classList.remove('ready');
                    pullText.textContent = 'Tarik untuk refresh';
                }
            }
        }, { passive: true });

        document.addEventListener('touchend', () => {
            if (isPulling && pullIndicator.classList.contains('ready')) {
                // Trigger refresh
                pullText.textContent = 'Refreshing...';
                setTimeout(() => {
                    window.location.reload();
                }, 300);
            } else {
                pullIndicator.classList.remove('pulling', 'ready');
            }
            isPulling = false;
        });

        // =========================================
        // INDEX MODE
        // =========================================
        async function initIndexMode() {
            $('#index-view').show();
            $('#detail-view').hide();
            $('.nav-title').text('Daftar Emiten');

            try {
                $('#loading-indicator').show();
                // Fetch Watchlist
                const response = await fetch(`${WORKER_BASE_URL}/watchlist`);
                const data = await response.json();

                $('#loading-indicator').hide();
                $('#app').fadeIn();

                if (data && data.watchlist) {
                    renderWatchlistTable(data.watchlist);
                } else {
                    alert('Gagal memuat watchlist.');
                }

            } catch (error) {
                console.error(error);
                $('#loading-indicator').hide();
                $('#app').fadeIn();
                $('#tbody-index').html('<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>');
            }
        }

        function renderWatchlistTable(watchlist) {
            const tbody = $('#tbody-index');
            tbody.empty();

            // Helpers for dates
            const today = new Date();
            const formatDate = (d) => d.toISOString().split('T')[0];

            const getDates = (days) => {
                const start = new Date();
                start.setDate(today.getDate() - days);
                return `start=${formatDate(start)}&end=${formatDate(today)}`;
            };

            watchlist.forEach((symbol, index) => {
                const row = `
                    <tr>
                        <td class="text-center text-muted">${index + 1}</td>
                        <td class="fw-bold">${symbol}</td>
                        <td class="text-center"><a href="?emiten=${symbol}&${getDates(7)}" class="btn btn-sm btn-outline-primary py-0" style="font-size:0.8rem;">7D</a></td>
                        <td class="text-center"><a href="?emiten=${symbol}&${getDates(14)}" class="btn btn-sm btn-outline-primary py-0" style="font-size:0.8rem;">14D</a></td>
                        <td class="text-center"><a href="?emiten=${symbol}&${getDates(30)}" class="btn btn-sm btn-outline-primary py-0" style="font-size:0.8rem;">30D</a></td>
                        <td class="text-center"><a href="?emiten=${symbol}&${getDates(90)}" class="btn btn-sm btn-outline-primary py-0" style="font-size:0.8rem;">90D</a></td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        // =========================================
        // DETAIL MODE
        // =========================================
        async function initDetailMode(symbol) {
            $('#index-view').hide();
            $('#detail-view').show();
            $('#header-title').text(symbol); // Just show symbol in header

            // Set Date Range Picker defaults
            let endDate = endParam ? new Date(endParam) : new Date();
            let startDate = startParam ? new Date(startParam) : new Date();
            if (!startParam) startDate.setDate(endDate.getDate() - 30); // Default 30 days

            $('#date-from').val(startDate.toISOString().split('T')[0]);
            $('#date-to').val(endDate.toISOString().split('T')[0]);

            // Fetch Data
            await loadDetailData(symbol, startDate, endDate);

            // Apply Filter Button
            $('#btn-apply-range').on('click', () => {
                const newFrom = $('#date-from').val();
                const newTo = $('#date-to').val();
                window.location.href = `?emiten=${symbol}&start=${newFrom}&end=${newTo}`;
            });
        }

        async function loadDetailData(symbol, start, end) {
            $('#loading-indicator').show();
            const fromDate = start.toISOString().split('T')[0];
            const toDate = end.toISOString().split('T')[0];

            try {
                const reloadParam = urlParams.get('cache-reload') === 'true' ? '&cache-reload=true' : '';
                const url = `${WORKER_BASE_URL}/chart-data?symbol=${symbol}&from=${fromDate}&to=${toDate}${reloadParam}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("Failed to fetch data");

                const result = await response.json();

                $('#loading-indicator').hide();
                $('#app').fadeIn();

                // Handle both old array format (fallback) and new object format
                let history = [];
                let summary = null;

                if (Array.isArray(result)) {
                    history = result;
                } else if (result.history) {
                    history = result.history;
                    summary = result.summary;
                }

                if (!history || history.length === 0) {
                    alert('Data tidak ditemukan untuk rentang tanggal ini.');
                    return;
                }

                processAndRenderDetail(history, summary);

            } catch (error) {
                console.error(error);
                $('#loading-indicator').hide();
                $('#app').fadeIn(); // Show app even on error to see alert
                alert('Terjadi kesalahan saat memuat data.');
            }
        }

        function processAndRenderDetail(history, brokerSummary) {
            // 1. CHART LOGIC
            // Filter out empty days (holidays/no transaction)
            history = history.filter(h => {
                if (!h.data) return false;
                const f = h.data.foreign?.net_val || 0;
                const r = h.data.retail?.net_val || 0;
                const l = h.data.local?.net_val || 0;
                // Keep if ANY sector has non-zero value
                return (f !== 0 || r !== 0 || l !== 0);
            });

            history.sort((a, b) => new Date(a.date) - new Date(b.date));

            // DEBUG: Show structure of first item
            // if (history.length > 0) {
            //     const first = history[0];
            //     const debugHtml = `<pre style="font-size:0.7rem; max-height: 200px; overflow:auto;">First Item Keys: ${JSON.stringify(first, null, 2)}</pre>`;
            //     $('.card-swing .card-body').html(debugHtml);
            // }

            // Render Chart
            const labels = history.map(h => h.date);
            const dataNet = history.map(h => {
                let val = 0;
                if (h.data && h.data.foreign) {
                    val = h.data.foreign.net_val || 0;
                }
                return val;
            });
            const dataRetail = history.map(h => {
                let val = 0;
                if (h.data && h.data.retail) {
                    val = h.data.retail.net_val || 0;
                }
                return val;
            });
            const dataLocal = history.map(h => {
                let val = 0;
                if (h.data && h.data.local) {
                    val = h.data.local.net_val || 0;
                }
                return val;
            });



            // Update Chart Label
            const ctx = document.getElementById("detailChart");
            if (window.myChart) window.myChart.destroy();

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Foreign',
                            data: dataNet,
                            borderColor: '#198754', // Green
                            backgroundColor: '#198754', // Match for legend
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            fill: false
                        },
                        {
                            label: 'Retail',
                            data: dataRetail,
                            borderColor: '#dc3545', // Red
                            backgroundColor: '#dc3545', // Match for legend
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            fill: false
                        },
                        {
                            label: 'Local',
                            data: dataLocal,
                            borderColor: '#0dcaf0', // Cyan
                            backgroundColor: '#0dcaf0', // Match for legend
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            right: 20 // Prevent last label clipping
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        // Custom formatting for tooltip
                                        const val = context.parsed.y;
                                        if (val === 0) return label + 'N/A';
                                        if (Math.abs(val) >= 1e9) return label + (val / 1e9).toFixed(2) + 'B';
                                        if (Math.abs(val) >= 1e6) return label + (val / 1e6).toFixed(2) + 'M';
                                        return label + val.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }, // No X grid
                            border: { display: false }, // No axis border for X
                            ticks: {
                                maxTicksLimit: 5,
                                maxRotation: 0,
                                minRotation: 0
                            }
                        },
                        y: {
                            grid: { display: false }, // No Y grid 
                            border: { display: false }, // No axis border line
                            ticks: {
                                color: '#94a3b8', // Axis label color
                                callback: function (value, index, values) {
                                    if (Math.abs(value) >= 1e9) return (value / 1e9).toFixed(1) + 'B';
                                    if (Math.abs(value) >= 1e6) return (value / 1e6).toFixed(1) + 'M';
                                    return value;
                                }
                            }
                        }
                    }
                }
            });

            // 2. TABLE LOGIC (Broker Summary)
            if (brokerSummary) {
                window.currentBrokerSummary = brokerSummary; // Store globally for toggle

                // Set toggle state from URL param (default: true/checked)
                const isNet = netParam !== 'false'; // Default is Net ON
                $('#toggleNet').prop('checked', isNet);

                renderBrokerTable(brokerSummary, isNet);

                // Toggle event listener - also updates URL
                $('#toggleNet').off('change').on('change', function () {
                    const newNetState = $(this).is(':checked');
                    renderBrokerTable(window.currentBrokerSummary, newNetState);

                    // Update URL without reload
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('net', newNetState);
                    window.history.replaceState({}, '', newUrl);
                });
            } else {
                $('#broker-table-container').html('<p class="text-muted text-center">Broker summary data not available.</p>');
            }

            // 3. AUDIT TRAIL
            renderAuditTrail(history);
        }

        function renderAuditTrail(history) {
            const fmt = (num) => {
                if (!num) return "-";
                const abs = Math.abs(num);
                if (abs >= 1e9) return (num / 1e9).toFixed(2) + "B";
                if (abs >= 1e6) return (num / 1e6).toFixed(2) + "M";
                return num.toLocaleString();
            };

            let html = '<div class="table-responsive"><table class="table table-sm small">';
            html += '<thead><tr class="text-muted"><th>Date</th><th class="text-end">Foreign Buy</th><th class="text-end">Foreign Sell</th><th class="text-end">Net</th></tr></thead>';
            html += '<tbody>';

            history.forEach(h => {
                const f = h.data?.foreign || {};
                const net = f.net_val || 0;
                const netClass = net >= 0 ? 'text-success' : 'text-danger';
                html += `
                    <tr>
                        <td>${h.date}</td>
                        <td class="text-end text-success">${fmt(f.buy_val)}</td>
                        <td class="text-end text-danger">${fmt(f.sell_val)}</td>
                        <td class="text-end fw-bold ${netClass}">${fmt(net)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            $('#audit-trail-list').html(html);
        }

        function renderBrokerTable(summary, isNet = true) {
            const fmt = (num) => {
                if (!num) return "-";
                const abs = Math.abs(num);
                if (abs >= 1e9) return (num / 1e9).toFixed(1) + "B";
                if (abs >= 1e6) return (num / 1e6).toFixed(1) + "M";
                return num.toLocaleString();
            };

            // Theme Colors
            const COLOR_BUY_BG = 'rgba(13, 202, 240, 0.15)'; // Cyan bg
            const COLOR_SELL_BG = 'rgba(253, 126, 20, 0.15)'; // Orange bg
            const BORDER_BUY = '#0aa2c0'; // Darker Cyan
            const BORDER_SELL = '#c66210'; // Darker Orange
            const STYLE_BUY_TEXT = 'color: #0dcaf0;';
            const STYLE_SELL_TEXT = 'color: #fd7e14;';

            const formatAvg = (num) => num ? Math.round(num).toLocaleString() : "-";

            // Get text color based on category
            const getTextClass = (code) => {
                const broker = brokersMap[code];
                if (!broker) return 'text-secondary'; // Unknown
                const cat = (broker.category || '').toLowerCase();
                if (cat.includes('foreign')) return 'text-success'; // Foreign = Green
                if (cat.includes('retail')) return 'text-danger';   // Retail = Red
                return 'text-primary'; // Local = Blue
            };

            // Get border color for visual bar
            const getBorderColor = (code) => {
                const broker = brokersMap[code];
                if (!broker) return '#6c757d'; // gray
                const cat = (broker.category || '').toLowerCase();
                if (cat.includes('foreign')) return '#198754'; // Green
                if (cat.includes('retail')) return '#dc3545';   // Red
                return '#0d6efd'; // Blue
            };

            // Get broker display name (first word only)
            const getBrokerLabel = (code) => {
                const broker = brokersMap[code];
                if (!broker) return code;
                // Short name: take first word only
                const shortName = broker.name.split(' ')[0];
                return `${code} - ${shortName}`;
            };

            // Mobile condensed label: Buy Side "(10B) Maybank - ZP"
            const getBuySideLabel = (code, net) => {
                const broker = brokersMap[code];
                const shortName = broker ? broker.name.split(' ')[0] : '';
                return `(${fmt(net)}) ${shortName} - ${code}`;
            };

            // Mobile condensed label: Sell Side "YP - Mirae (-5.3B)"
            const getSellSideLabel = (code, net) => {
                const broker = brokersMap[code];
                const shortName = broker ? broker.name.split(' ')[0] : '';
                return `${code} - ${shortName} (${fmt(net)})`;
            };

            let html = '';




            if (isNet && summary.top_net_buyers) {
                // Calculate max for bar scaling (GLOBAL for both tables)
                const maxNet = Math.max(...(summary.top_net_buyers || []).map(b => Math.abs(b.net)));
                const maxNetSell = Math.max(...(summary.top_net_sellers || []).map(s => Math.abs(s.net)));
                const globalMax = Math.max(maxNet, maxNetSell);

                // NET VIEW: Two columns (Top Net Buyer | Top Net Seller)
                // NET VIEW: Two columns (Top Net Buyer | Top Net Seller)
                html = `
                <div class="row">
                    <div class="col-6">
                        <table class="table table-sm table-borderless small broker-table-mobile">
                            <thead><tr class="text-muted"><th class="text-end hide-mobile">Net</th><th class="text-end hide-mobile">Avg</th><th class="text-end hide-mobile">Buy</th><th class="text-end hide-mobile">Sell</th><th class="text-end">Buy Side Broker</th></tr></thead>
                            <tbody>
                                ${(summary.top_net_buyers || []).map((b, i) => {
                    const ratio = globalMax > 0 ? Math.abs(b.net) / globalMax : 0;
                    const percentage = Math.round(ratio * 95);
                    // Proportional Height: Max 100px, Min 35px
                    const rowHeight = Math.max(35, Math.round(ratio * 100));
                    // Dynamic Border Width: 1px to 5px based heavily on ratio
                    const barWidth = Math.max(1, Math.round(ratio * 5));

                    const rowStyle = `height: ${rowHeight}px; vertical-align: middle;`;

                    // Calculate Avg Price (Buy Avg for Net Buyers)
                    // Assumption: bvol is in Shares. If Lots, * 100. adjusted if needed.
                    const avg = b.bvol ? Math.round(b.bval / b.bvol) : 0;

                    // BUY SIDE: Bar anchors RIGHT
                    // Using a DIV for the bar to allow absolute positioning relative to the TD
                    const barHtml = `<div style="
                        position: absolute;
                        top: 0; bottom: 0; right: 0;
                        width: ${percentage}%;
                        background-color: rgba(13, 202, 240, 0.25);
                        border-right: ${barWidth}px solid #0aa2c0;
                        z-index: 0;
                    "></div>`;

                    return `<tr style="${rowStyle}">
                                        <td class="text-end fw-bold hide-mobile" style="${STYLE_BUY_TEXT}">${fmt(b.net)}</td>
                                        <td class="text-end hide-mobile text-muted">${fmt(avg)}</td>
                                        <td class="text-end hide-mobile" style="${STYLE_BUY_TEXT}">${fmt(b.bval)}</td>
                                        <td class="text-end hide-mobile" style="${STYLE_SELL_TEXT}">${fmt(b.sval)}</td>
                                        <td class="text-end" style="position: relative; padding-right: 8px;">
                                            ${barHtml}
                                            <span class="fw-bold ${getTextClass(b.code)} d-none d-md-inline" style="position: relative; z-index: 1;">${getBrokerLabel(b.code)}</span>
                                            <span class="fw-bold ${getTextClass(b.code)} d-inline d-md-none" style="position: relative; z-index: 1;">${getBuySideLabel(b.code, b.net)}</span>
                                        </td>
                                    </tr>`;
                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="col-6">
                        <table class="table table-sm table-borderless small broker-table-mobile">
                            <thead><tr class="text-muted"><th>Sell Side Broker</th><th class="text-start hide-mobile">Buy</th><th class="text-start hide-mobile">Sell</th><th class="text-start hide-mobile">Avg</th><th class="text-start hide-mobile">Net</th></tr></thead>
                            <tbody>
                                ${(summary.top_net_sellers || []).map((s, i) => {
                    const ratio = globalMax > 0 ? Math.abs(s.net) / globalMax : 0;
                    const percentage = Math.round(ratio * 95);
                    // Proportional Height: Max 100px, Min 35px
                    const rowHeight = Math.max(35, Math.round(ratio * 100));
                    // Dynamic Border Width: 1px to 5px based heavily on ratio
                    const barWidth = Math.max(1, Math.round(ratio * 5));

                    const rowStyle = `height: ${rowHeight}px; vertical-align: middle;`;

                    // Calculate Avg Price (Sell Avg for Net Sellers)
                    const avg = s.svol ? Math.round(s.sval / s.svol) : 0;

                    // SELL SIDE: Bar anchors LEFT
                    const barHtml = `<div style="
                        position: absolute;
                        top: 0; bottom: 0; left: 0;
                        width: ${percentage}%;
                        background-color: rgba(253, 126, 20, 0.25);
                        border-left: ${barWidth}px solid #c66210;
                        z-index: 0;
                    "></div>`;

                    return `<tr style="${rowStyle}">
                                        <td style="position: relative; padding-left: 8px;">
                                            ${barHtml}
                                            <span class="fw-bold ${getTextClass(s.code)} d-none d-md-inline" style="position: relative; z-index: 1;">${getBrokerLabel(s.code)}</span>
                                            <span class="fw-bold ${getTextClass(s.code)} d-inline d-md-none" style="position: relative; z-index: 1;">${getSellSideLabel(s.code, s.net)}</span>
                                        </td>
                                        <td class="text-start hide-mobile" style="${STYLE_BUY_TEXT}">${fmt(s.bval)}</td>
                                        <td class="text-start hide-mobile" style="${STYLE_SELL_TEXT}">${fmt(s.sval)}</td>
                                        <td class="text-start hide-mobile text-muted">${fmt(avg)}</td>
                                        <td class="text-start fw-bold hide-mobile" style="${STYLE_SELL_TEXT}">${fmt(s.net)}</td>
                                    </tr>`;
                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            } else {
                // Calculate max for bar scaling
                const maxBuy = Math.max(...(summary.top_buyers || []).map(b => b.val));
                const maxSell = Math.max(...(summary.top_sellers || []).map(s => s.val));

                // GROSS VIEW: Two columns (Top Buyer | Top Seller)
                html = `
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless small">
                            <thead><tr class="text-muted"><th>Buy Side Broker</th><th class="text-end">Value</th><th class="text-end">Avg</th></tr></thead>
                            <tbody>
                                ${summary.top_buyers.map((b, i) => {
                    const ratio = maxBuy > 0 ? b.val / maxBuy : 0;
                    const percentage = Math.round(ratio * 95);
                    // NO height scaling for Gross
                    const barWidth = maxBuy > 0 ? (b.val / maxBuy) * 5 : 1;

                    // Calculate Avg
                    const avg = b.vol ? Math.round(b.val / b.vol) : 0;

                    const rowStyle = `
                        background: linear-gradient(90deg, rgba(13, 202, 240, 0.25) ${percentage}%, transparent ${percentage}%) !important;
                        vertical-align: middle;
                    `;
                    const borderStyle = `border-left: ${barWidth}px solid #0aa2c0; padding-left: 8px;`;

                    return `<tr style="${rowStyle}">
                                        <td style="${borderStyle}"><span class="fw-bold ${getTextClass(b.code)}">${getBrokerLabel(b.code)}</span></td>
                                        <td class="text-end fw-bold" style="${STYLE_BUY_TEXT}">${fmt(b.val)}</td>
                                        <td class="text-end text-muted">${fmt(avg)}</td>
                                    </tr>`;
                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6 border-start">
                        <table class="table table-sm table-borderless small">
                            <thead><tr class="text-muted"><th>Sell Side Broker</th><th class="text-end">Value</th><th class="text-end">Avg</th></tr></thead>
                            <tbody>
                                ${summary.top_sellers.map((s, i) => {
                    const ratio = maxSell > 0 ? s.val / maxSell : 0;
                    const percentage = Math.round(ratio * 95);
                    // NO height scaling for Gross
                    const barWidth = maxSell > 0 ? (s.val / maxSell) * 5 : 1;

                    // Calculate Avg
                    const avg = s.vol ? Math.round(s.val / s.vol) : 0;

                    const rowStyle = `
                        background: linear-gradient(90deg, rgba(253, 126, 20, 0.25) ${percentage}%, transparent ${percentage}%) !important;
                        vertical-align: middle;
                    `;
                    const borderStyle = `border-left: ${barWidth}px solid #c66210; padding-left: 8px;`;

                    return `<tr style="${rowStyle}">
                                        <td style="${borderStyle}"><span class="fw-bold ${getTextClass(s.code)}">${getBrokerLabel(s.code)}</span></td>
                                        <td class="text-end fw-bold" style="${STYLE_SELL_TEXT}">${fmt(s.val)}</td>
                                        <td class="text-end text-muted">${fmt(avg)}</td>
                                    </tr>`;
                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            }

            $('#broker-table-container').html(html);
        }
    </script>
</body>

</html>