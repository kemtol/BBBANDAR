<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0b0b0e" />

    <script>
        (function () {
            const STORAGE_KEY = 'ui:theme';
            const root = document.documentElement;
            try {
                const saved = window.localStorage ? localStorage.getItem(STORAGE_KEY) : null;
                const theme = saved || 'dark';
                root.setAttribute('data-theme', theme);
                root.style.colorScheme = theme === 'dark' ? 'dark' : 'light';
            } catch (error) {
                root.setAttribute('data-theme', 'dark');
                root.style.colorScheme = 'dark';
            }
        })();
    </script>

    <title>SSSAHAM - Dashboard</title>

    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">

    <!-- Bootstrap & Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../theme.css" />
    <link href="css/styles.css" rel="stylesheet" />

    <style>
        :root {
            --table-header-text: var(--muted);
            --table-hover-bg: #f1f5f9;
            --card-divider: rgba(148, 163, 184, 0.35);
            --card-radius: 12px;
            --pull-indicator-bg: #f6f8fb;
            --pull-indicator-icon: var(--muted);
        }

        :root[data-theme="dark"] {
            --table-hover-bg: rgba(255, 255, 255, 0.05);
            --card-divider: rgba(82, 94, 106, 0.55);
            --pull-indicator-bg: var(--surface-alt);
            --pull-indicator-icon: var(--text-secondary);
        }

        body {
            background: var(--bg);
            color: var(--text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body,
        .card,
        .navbar,
        .dropdown-menu,
        .form-control,
        .modal-content {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .bg-white {
            background-color: var(--surface) !important;
            color: var(--text);
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .card {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            color: var(--text);
        }

        .navbar {
            box-shadow: none;
        }

        #theme-toggle-icon {
            cursor: pointer;
            color: var(--navbar-text);
            transition: color 0.2s ease;
        }

        #theme-toggle-icon:hover {
            color: var(--navbar-highlight);
        }

        #pull-indicator {
            position: fixed;
            top: -60px;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--pull-indicator-bg);
            transition: top 0.2s ease-out;
            z-index: 1000;
            color: var(--pull-indicator-icon);
        }

        #pull-indicator.visible {
            top: 0;
        }

        #pull-indicator i {
            font-size: 1.5rem;
            color: var(--pull-indicator-icon);
            transition: transform 0.2s;
        }

        #pull-indicator.ready i {
            transform: rotate(180deg);
        }

        .nav-title {
            font-size: 0.9rem !important;
        }

        html[data-theme="dark"] .dropdown-menu {
            background-color: var(--surface-alt);
            border-color: var(--border);
            color: var(--text);
        }

        html[data-theme="dark"] .dropdown-item:hover {
            background-color: var(--table-hover-bg);
            color: var(--text);
        }

        html[data-theme="dark"] .form-control {
            background-color: var(--surface-alt);
            color: var(--text);
            border-color: var(--border);
        }

        html[data-theme="dark"] .form-control::placeholder {
            color: var(--text-muted);
        }

        html[data-theme="dark"] .modal-content {
            background-color: var(--surface);
            color: var(--text);
            border-color: var(--border);
        }

        html[data-theme="dark"] .modal-header,
        html[data-theme="dark"] .modal-footer {
            border-color: var(--border);
        }

        html[data-theme="dark"] .spinner-border.text-primary {
            color: var(--primary) !important;
        }

        html[data-theme="dark"] .bg-light {
            background-color: var(--surface-alt) !important;
            color: var(--text);
        }
    </style>

    <script>
        // ========================================
        // DEV_MODE: Set to true to skip auth guard
        // ========================================
        const DEV_MODE = true;

        // Auth Guard: Check if token exists
        if (!DEV_MODE) {
            const token = localStorage.getItem("qqquanta_token");
            if (!token) {
                window.location.href = "login.html";
            }
        }
    </script>
</head>

<body>
    <!-- Pull to Refresh Indicator -->
    <div id="pull-indicator">
        <i class="fa-solid fa-arrow-down"></i>
        <span class="ms-2 small text-muted" id="pull-text">Tarik untuk refresh</span>
    </div>

    <!-- NAVBAR -->
    <nav class="navbar sticky-top py-3">
        <div class="container d-flex align-items-center justify-content-between" style="max-width: 1440px;position: relative;">
            <div class="d-flex align-items-center gap-3" style="min-width: 140px;">
                <i class="fa-solid fa-circle-half-stroke" id="theme-toggle-icon" title="Toggle theme (Shift + D)"></i>
            </div>
            <div class="flex-grow-1 text-center">
                <span class="nav-title" id="header-title">Dashboard</span>
            </div>
            <div style="width:72px;" class="text-end">
                <i class="fa-solid fa-magnifying-glass" style="cursor: pointer;" onclick="toggleSearch()"></i>
            </div>
        </div>
    </nav>

    <div id="search-panel">
        <div class="mb-4">
            <input type="text" id="search-input" class="search-input" placeholder="Masukkan Kode (e.g. BBRI)"
                autocomplete="off">
        </div>

        <div>
            <p class="small opacity-75 mb-2 fw-bold">RIWAYAT PENCARIAN</p>
            <div id="search-history-list">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <div id="loading-indicator" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="small text-muted mt-2">Memuat data...</p>
    </div>

    <div id="app" class="container mb-3" style="display:none;">
        <!-- VIEW 1: INDEX (DAFTAR EMITEN) -->
        <div id="index-view">
            <!-- DASHBOARD TABS -->
            <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" href="#">Feed</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" href="emiten/broker-summary.html">Brokerflow</a>
                </li>
            </ul>
        </div>

        <!-- Filter Section -->
        <section id="filters" class="filter-section mb-4 d-none">
            <div class="container ps-0">
                <div class="filter-scroll">
                    <div class="filter-icon">
                        <i class="fa-solid fa-sliders text-secondary small"></i>
                        <span class="filter-divider"></span>
                    </div>
                    <button class="filter-pill active">All</button>
                    <button class="filter-pill">Nasdaq</button>
                    <button class="filter-pill">S&P500</button>
                    <button class="filter-pill">Gold</button>
                    <button class="filter-pill">BTC Futures</button>
                    <button class="filter-pill">EUR/USD</button>
                    <button class="filter-pill">GBP/USD</button>
                    <button class="filter-pill">USD/JPY</button>
                </div>
            </div>
        </section>

        <section id="content" class="content-section mt-0 pt-0">
            <div class="container ps-0">
                <div class="row">
                    <!-- Feed Section (Left) -->
                    <div class="col-md-6 mb-4">
                        <strong class="section-heading mb-3 d-block text-center">Feed</strong>
                        <div class="timeline timeline-right" id="feed-timeline">
                            <div class="timeline-line"></div>
                        </div>
                    </div>

                    <!-- Catalyst Section (Right) -->
                    <div class="col-md-6 mb-4">
                        <strong class="section-heading mb-3 text-center d-block">Catalyst</strong>
                        <div class="timeline" id="catalyst-timeline">
                            <div class="timeline-line"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="feed-detail-section" class="content-section mt-0 pt-0 d-none">
            <div class="container ps-0">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <button class="btn btn-sm btn-outline-secondary" onclick="backToFeedList()">
                        <i class="fa-solid fa-arrow-left me-1"></i>Kembali ke Feed
                    </button>
                </div>
                <div id="feed-detail-card" class="timeline-card">
                    <p class="timeline-text mb-0">Memuat detail...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Init Script to Simulate Loading -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Slight delay to smoother transition or immediate
            setTimeout(() => {
                const loader = document.getElementById("loading-indicator");
                const app = document.getElementById("app");
                if (loader) loader.style.display = "none";
                if (app) app.style.display = "block";
            }, 500); // 500ms delay for visual feedback
        });
    </script>

    <script>
        const WORKER_BASE_URL = "https://api-saham.mkemalw.workers.dev";

        function escapeHtml(value) {
            return String(value || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function relativeTimeFrom(dateStr) {
            const ts = Date.parse(dateStr || '');
            if (!Number.isFinite(ts)) return '-';
            const delta = Date.now() - ts;
            const mins = Math.round(delta / 60000);
            if (mins < 1) return 'baru saja';
            if (mins < 60) return `${mins} menit lalu`;
            const hours = Math.round(mins / 60);
            if (hours < 24) return `${hours} jam lalu`;
            const days = Math.round(hours / 24);
            return `${days} hari lalu`;
        }

        function upcomingLabel(dateStr, timeStr) {
            const iso = `${dateStr || ''}T${(timeStr || '00:00')}:00+07:00`;
            const ts = Date.parse(iso);
            if (!Number.isFinite(ts)) return '-';
            const delta = ts - Date.now();
            if (delta <= 0) return 'sudah lewat';
            const mins = Math.round(delta / 60000);
            if (mins < 60) return `dalam ${mins} menit`;
            const hrs = Math.round(mins / 60);
            if (hrs < 24) return `dalam ${hrs} jam`;
            const days = Math.round(hrs / 24);
            return `dalam ${days} hari`;
        }

        let timelineLogoSyncTimer = null;

        function syncTimelineLogoDots() {
            const items = document.querySelectorAll('.timeline .timeline-item');
            items.forEach((item) => {
                const dot = item.querySelector('.timeline-dot.logo-dot');
                const card = item.querySelector('.timeline-card');
                if (!dot || !card) return;

                const cardHeight = card.offsetHeight || 0;
                if (!cardHeight) return;

                const size = 36;
                const timeEl = item.querySelector('.timeline-time');
                const timeStyle = timeEl ? window.getComputedStyle(timeEl) : null;
                const timeMarginBottom = timeStyle ? parseFloat(timeStyle.marginBottom || '0') : 0;
                const timeBlockHeight = timeEl ? (timeEl.offsetHeight + (Number.isFinite(timeMarginBottom) ? timeMarginBottom : 0)) : 0;
                const top = Math.max(0, timeBlockHeight + ((cardHeight - size) / 2));

                item.style.setProperty('--logo-dot-size', `${size}px`);
                item.style.setProperty('--logo-dot-top', `${top}px`);
            });
        }

        function scheduleTimelineLogoDotSync() {
            if (timelineLogoSyncTimer) window.clearTimeout(timelineLogoSyncTimer);
            timelineLogoSyncTimer = window.setTimeout(() => {
                timelineLogoSyncTimer = null;
                syncTimelineLogoDots();
            }, 0);
        }

        function timelineDotHtml(dotClass, symbol) {
            const s = String(symbol || '').trim().toUpperCase();
            if (!s) return `<div class="timeline-dot ${dotClass}"></div>`;
            const logo = `${WORKER_BASE_URL}/logo?symbol=${encodeURIComponent(s)}`;
            return `<div class="timeline-dot logo-dot ${dotClass}"><img src="${logo}" alt="${escapeHtml(s)}" onerror="this.parentElement.classList.remove('logo-dot'); this.parentElement.innerHTML='';"></div>`;
        }

        function slugifyText(v) {
            return String(v || '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '')
                .replace(/-{2,}/g, '-');
        }

        function buildFeedDetailSlug(item) {
            const created = new Date(item?.created_at || Date.now());
            const y = created.getFullYear();
            const m = String(created.getMonth() + 1).padStart(2, '0');
            const d = String(created.getDate()).padStart(2, '0');
            const symbol = String(item?.symbol || '').toUpperCase() || 'EMITEN';
            const title = String(item?.title || 'update');
            const titleWithoutSymbol = title
                .replace(new RegExp(`^${symbol}\\s*`, 'i'), '')
                .replace(/[•|:]/g, ' ')
                .trim();
            const reco = slugifyText(titleWithoutSymbol || 'update') || 'update';
            return `${y}-${m}-${d}-${symbol}-${reco}`;
        }

        function openFeedDetail(item) {
            const slug = String(item?.slug || '').trim() || buildFeedDetailSlug(item);
            const url = `${window.location.pathname}?feed=${encodeURIComponent(slug)}`;
            window.location.href = url;
        }

        function backToFeedList() {
            window.location.href = window.location.pathname;
        }

        function setFeedDetailMode(isDetail) {
            const listSection = document.getElementById('content');
            const detailSection = document.getElementById('feed-detail-section');
            if (listSection) listSection.classList.toggle('d-none', !!isDetail);
            if (detailSection) detailSection.classList.toggle('d-none', !isDetail);
        }

        function formatLocalDateTime(v) {
            const ts = Date.parse(String(v || ''));
            if (!Number.isFinite(ts)) return '-';
            return new Date(ts).toLocaleString('id-ID', {
                year: 'numeric', month: 'short', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function renderFeedDetail(payload, slug) {
            const root = document.getElementById('feed-detail-card');
            if (!root) return;

            if (!payload?.ok || !payload?.item) {
                root.innerHTML = `<div class="timeline-title variant-red">Detail tidak ditemukan</div><p class="timeline-text mb-0">Feed dengan slug <strong>${escapeHtml(slug || '-')}</strong> tidak tersedia.</p>`;
                return;
            }

            const item = payload.item || {};
            const detail = payload.detail || {};
            const analysis = detail.analysis || {};
            const recID = analysis?.kesimpulan_rekomendasi || {};
            const recEN = analysis?.recommendation || {};
            const confidence = Number(item?.meta?.confidence ?? recID?.confidence ?? recEN?.confidence ?? 0) || 0;

            const reasons = Array.isArray(recID?.alasan_rating)
                ? recID.alasan_rating
                : (typeof recEN?.rationale === 'string' && recEN.rationale.trim() ? [recEN.rationale.trim()] : []);

            const screenshots = Array.isArray(detail?.screenshots) ? detail.screenshots : [];
            const screenshotsHtml = screenshots.length
                ? `<div class="timeline-tags mb-2">${screenshots.map((s, idx) => `<a href="${escapeHtml(s?.url || '#')}" target="_blank" rel="noopener noreferrer">Screenshot ${idx + 1}</a>`).join('')}</div>`
                : '<p class="timeline-text mb-2">Tidak ada screenshot terkait.</p>';

            const raw = typeof detail?.analysis_raw === 'string' ? detail.analysis_raw.trim() : '';
            const rawHtml = raw
                ? `<details class="mt-2"><summary class="timeline-time">Lihat output mentah AI</summary><pre class="small mt-2 mb-0" style="white-space: pre-wrap; color: var(--text-secondary);">${escapeHtml(raw)}</pre></details>`
                : '';

            root.innerHTML = `
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="primary mb-0">${escapeHtml(item?.title || 'AI Analysis')}</div>
                    <div class="">${escapeHtml(formatLocalDateTime(item?.created_at))}</div>
                </div>
                <p class="mb-2">${escapeHtml(item?.body || '-')}</p>
                <div class="timeline-tags mb-3">
                    <span>#${escapeHtml(item?.symbol || '-')}</span>
                    <span>#confidence-${Math.round(confidence)}%</span>
                    <span>#${escapeHtml(detail?.provider || item?.meta?.provider || 'provider')}</span>
                </div>
                <div class="timeline-card variant-blue mb-3">
                    <div class="variant-blue">Ringkasan Rekomendasi</div>
                    <p class="timeline-text mb-1"><strong>Rating:</strong> ${escapeHtml(recID?.rating || recID?.rekomendasi || recEN?.position || '-')}</p>
                    <p class="timeline-text mb-0"><strong>Rentang Data:</strong> ${escapeHtml(detail?.date_range?.from || item?.meta?.from || '-')} → ${escapeHtml(detail?.date_range?.to || item?.meta?.to || '-')}</p>
                </div>
                <div class="timeline-card variant-purple mb-3">
                    <div class="variant-purple">Alasan Utama</div>
                    ${reasons.length ? `<ul class="mb-0">${reasons.map((r) => `<li class="timeline-text mb-1">${escapeHtml(r)}</li>`).join('')}</ul>` : '<p class="timeline-text mb-0">Tidak ada alasan detail tersimpan.</p>'}
                </div>
                <div class="timeline-card mb-2">
                    <div class="">Lampiran</div>
                    ${screenshotsHtml}
                    ${rawHtml}
                </div>
            `;
        }

        async function loadFeedDetail(slug) {
            setFeedDetailMode(true);
            const root = document.getElementById('feed-detail-card');
            if (root) root.innerHTML = '<p class="timeline-text mb-0">Memuat detail...</p>';

            try {
                const resp = await fetch(`${WORKER_BASE_URL}/dashboard/feed/detail?slug=${encodeURIComponent(slug)}`);
                const data = await resp.json().catch(() => ({ ok: false }));
                renderFeedDetail(data, slug);
            } catch (error) {
                console.error('[dashboard] feed detail failed', error);
                renderFeedDetail({ ok: false }, slug);
            }
        }

        function renderFeed(items) {
            const root = document.getElementById('feed-timeline');
            if (!root) return;
            const line = '<div class="timeline-line"></div>';

            if (!Array.isArray(items) || items.length === 0) {
                root.innerHTML = `${line}<div class="timeline-item"><div class="timeline-dot"></div><div class="timeline-time">-</div><div class="timeline-card"><div class="timeline-title">Feed</div><p class="timeline-text">Belum ada feed terbaru.</p></div></div>`;
                return;
            }

            const html = items.map((it, i) => {
                const dotClass = i === 0 ? 'primary' : 'success';
                const title = escapeHtml(it?.title || 'AI Analysis');
                const body = escapeHtml(it?.body || 'Analisis terbaru tersedia.');
                const symbol = escapeHtml(it?.symbol || '');
                const slug = encodeURIComponent(String(it?.slug || buildFeedDetailSlug(it)));
                return `<div class="timeline-item">
                    ${timelineDotHtml(dotClass, symbol)}
                    <div class="timeline-time">${relativeTimeFrom(it?.created_at)}</div>
                    <div class="timeline-card feed-clickable" data-feed-slug="${slug}" onclick="openFeedDetail({ slug: decodeURIComponent(this.dataset.feedSlug) })">
                        <div class="timeline-title ${dotClass}">${title}</div>
                        <p class="timeline-text">${body}</p>
                        <div class="timeline-tags">${symbol ? `<span>#${symbol}</span>` : ''}<span>#AI</span></div>
                    </div>
                </div>`;
            }).join('');

            root.innerHTML = line + html;
            scheduleTimelineLogoDotSync();
        }

        function renderCatalyst(items) {
            const root = document.getElementById('catalyst-timeline');
            if (!root) return;
            const line = '<div class="timeline-line"></div>';

            if (!Array.isArray(items) || items.length === 0) {
                root.innerHTML = `${line}<div class="timeline-item"><div class="timeline-dot"></div><div class="timeline-time">-</div><div class="timeline-card"><div class="timeline-title">Catalyst</div><p class="timeline-text">Belum ada catalyst event.</p></div></div>`;
                return;
            }

            const html = items.map((it, i) => {
                const variant = it?.type === 'pubex' ? 'variant-purple' : 'variant-red';
                const title = escapeHtml(it?.title || 'Event');
                const subtitle = escapeHtml(it?.subtitle || '');
                const desc = escapeHtml(it?.description || '-');
                const when = upcomingLabel(it?.event_date, it?.event_time_wib);
                const source = escapeHtml(it?.source || 'source');
                const symbol = escapeHtml(it?.symbol || '');
                return `<div class="timeline-item ${i > 0 ? 'upcoming' : ''}">
                    ${timelineDotHtml(variant, symbol)}
                    <div class="timeline-time">${when}</div>
                    <div class="timeline-card ${variant}">
                        <div class="timeline-title ${variant}">${title}</div>
                        <p class="timeline-text">${subtitle ? `<strong>${subtitle}</strong> — ` : ''}${desc}</p>
                        <div class="timeline-tags"><span>#${escapeHtml(it?.type || 'event')}</span><span>#${source}</span></div>
                    </div>
                </div>`;
            }).join('');

            root.innerHTML = line + html;
            scheduleTimelineLogoDotSync();
        }

        async function loadDashboardData() {
            setFeedDetailMode(false);
            try {
                const [feedResp, catalystResp] = await Promise.all([
                    fetch(`${WORKER_BASE_URL}/dashboard/feed?limit=30`),
                    fetch(`${WORKER_BASE_URL}/dashboard/catalyst?limit=30`)
                ]);

                const feedJson = await feedResp.json().catch(() => ({ items: [] }));
                const catJson = await catalystResp.json().catch(() => ({ items: [] }));

                renderFeed(feedJson?.items || []);
                renderCatalyst(catJson?.items || []);
            } catch (e) {
                console.error('[dashboard] load failed', e);
                renderFeed([]);
                renderCatalyst([]);
            }
        }

        // Page specific logic updates
        const userStr = localStorage.getItem("qqquanta_user");
        if (userStr) {
            try {
                const user = JSON.parse(userStr);
                // Update Header Name
                const userNameEl = document.getElementById("user-name");
                if (userNameEl) userNameEl.textContent = user.name || "User";

                // Update Page Details
                const details = document.getElementById("user-details");
                if (details) {
                    details.innerHTML = `
                    ${user.picture ? `<img src="${user.picture}" alt="Profile">` : ''}
                    <div>
                        <h5 class="mb-1">${user.name}</h5>
                        <p class="mb-0 text-muted">${user.email}</p>
                    </div>
                `;
                }
            } catch (e) { console.error(e); }
        } else {
            // DEV_MODE: Show placeholder
            const details = document.getElementById("user-details");
            if (details) {
                details.innerHTML = `
                <img src="https://via.placeholder.com/64" alt="Profile">
                <div>
                    <h5 class="mb-1">Dev User</h5>
                    <p class="mb-0 text-muted">dev@qqquanta.com</p>
                </div>
            `;
            }
            const userNameEl = document.getElementById("user-name");
            if (userNameEl) userNameEl.textContent = "Dev User";
        }

        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                localStorage.removeItem("qqquanta_token");
                localStorage.removeItem("qqquanta_user");
                window.location.href = "login.html";
            }
        }

        function toggleMobileMenu() {
            // TODO: Implement mobile menu
            alert("Mobile menu coming soon!");
        }

        // Trading Hours Clock Logic
        const tradingSessions = {
            tokyo: { open: 9, close: 15, tz: 'Asia/Tokyo' },
            london: { open: 8, close: 16, tz: 'Europe/London' },
            newyork: { open: 9, close: 16, tz: 'America/New_York' }
        };

        function getTimeInTimezone(tz) {
            const now = new Date();
            const options = { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: false };
            const timeStr = now.toLocaleTimeString('en-GB', options);
            const [hours, minutes] = timeStr.split(':').map(Number);
            return { hours, minutes, timeStr };
        }

        function isMarketOpen(session, hours) {
            // Check if weekday (Mon-Fri)
            const now = new Date();
            const dayOptions = { timeZone: session.tz, weekday: 'short' };
            const day = now.toLocaleDateString('en-US', dayOptions);
            const isWeekday = !['Sat', 'Sun'].includes(day);

            return isWeekday && hours >= session.open && hours < session.close;
        }

        function updateClocks() {
            Object.keys(tradingSessions).forEach(city => {
                const session = tradingSessions[city];
                const { hours, minutes, timeStr } = getTimeInTimezone(session.tz);

                // Update time display
                const timeEl = document.getElementById(`${city}-time`);
                if (timeEl) timeEl.textContent = timeStr;

                // Update clock hands
                const hourDeg = (hours % 12) * 30 + minutes * 0.5;
                const minuteDeg = minutes * 6;

                const hourEl = document.getElementById(`${city}-hour`);
                const minuteEl = document.getElementById(`${city}-minute`);
                if (hourEl) hourEl.style.transform = `rotate(${hourDeg}deg)`;
                if (minuteEl) minuteEl.style.transform = `rotate(${minuteDeg}deg)`;

                // Update market status
                const statusEl = document.getElementById(`${city}-status`);
                const isOpen = isMarketOpen(session, hours);
                if (statusEl) {
                    statusEl.textContent = isOpen ? 'OPEN' : 'CLOSED';
                    statusEl.className = `clock-status ${isOpen ? 'open' : 'closed'}`;
                }

                // Update Wrapper Opacity
                const wrapper = document.getElementById(`clock-wrapper-${city}`);
                if (wrapper) {
                    wrapper.style.opacity = isOpen ? '1' : '0.7';
                }
            });
        }

        // Initial update and set interval
        updateClocks();
        setInterval(updateClocks, 1000);

        async function initializeDashboardRoute() {
            const params = new URLSearchParams(window.location.search);
            const feedSlug = String(params.get('feed') || '').trim();
            if (feedSlug) {
                await loadFeedDetail(feedSlug);
                return;
            }
            await loadDashboardData();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboardRoute();
            scheduleTimelineLogoDotSync();
        });

        window.addEventListener('resize', scheduleTimelineLogoDotSync);
    </script>

    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="emiten/component.js"></script>
</body>

</html>
