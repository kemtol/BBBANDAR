<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#ffffff" />

    <title>SSSAHAM - Orderflow Scanner</title>

    <!-- (opsional) samain dengan index.html -->
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="apple-touch-icon" sizes="180x180" href="../img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../img/favicon-16x16.png">

    <!-- Bootstrap & Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" />
    <link href="component.css" rel="stylesheet" />

    <style>
        .card-swing {
            border-radius: 12px;
            border: none;
        }

        .card-swing-header {
            background: transparent;
            border-bottom: 1px solid rgba(148, 163, 184, 0.4);
            border-radius: 12px 12px 0 0;
            padding: 0.5rem 0.75rem;
        }

        .table-orderflow {
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .table-orderflow thead th {
            text-transform: uppercase;
            font-size: 0.9rem;
            color: #6b7280;
            border-bottom-color: #e5e7eb;
        }

        .table-orderflow tbody tr {
            cursor: pointer;
        }

        .table-orderflow tbody tr:hover {
            background-color: #f1f5f9;
        }

        .table-orderflow thead th.sortable {
            position: relative;
            padding-right: 14px;
            /* ruang untuk icon */
        }

        .sort-icon {
            position: absolute;
            right: 2px;
            top: 50%;
            transform: translateY(-50%);
        }

        .sort-icon.active {
            opacity: 1;
        }



        .quadrant-badge {
            width: 18px;
            text-align: center;
            border-radius: 999px;
            font-size: 0.7rem;
            display: block;
            height: 18px;
            position: relative;
            left: 5px;
        }

        .stat-pill {
            font-size: 0.7rem;
            border-radius: 999px;
            padding: 2px 8px;
        }

        .quad-legend {
            font-size: 0.7rem;
            color: #6b7280;
        }

        .heartbeat-pulse {
            width: 8px;
            height: 8px;
            background-color: #22c55e;
            border-radius: 50%;
            display: inline-block;
            animation: pulse-animation 2s infinite;
        }

        @keyframes pulse-animation {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }
    </style>
</head>

<body>
    <nav class="navbar sticky-top">
        <div class="container d-flex align-items-center" style="max-width: 1200px; position: relative;">
            <div style="width:72px;"></div>
            <div class="flex-grow-1 text-center">
                <span class="nav-title">Dashboard</span>
            </div>
            <div style="width:72px;" class="text-end">
                <i class="fa-solid fa-magnifying-glass" style="cursor: pointer;" onclick="toggleSearch()"></i>
            </div>
        </div>
    </nav>

    <div id="loading-indicator" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="small text-muted mt-2">Memuat data orderflow...</p>
    </div>

    <div id="app" class="container mb-3">
        <!-- NAVIGATION TABS -->
        <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="../index.html">Feed</a>
            </li>
            <li class="nav-item" role="presentation">
                <span class="nav-link active">Orderflow</span>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="broker-summary.html">Brokerflow</a>
            </li>
        </ul>

        <!-- INFO BANNER -->
        <div class="alert alert-light border small mb-3 d-none">
            <strong>Swing Orderflow Scanner (Skeleton).</strong><br />
            Halaman ini membaca snapshot dari livetrade-taping untuk mode <em>swing</em>.
            Nanti dihubungkan ke Worker: <code>/summary?mode=swing</code> dan <code>/symbol</code>.
        </div>

        <!-- 4-QUADRANT HEATMAP (Chart.js) -->
        <div class="mb-3">
            <div style="height:50vh;">
                <canvas id="quadChart"></canvas>
            </div>
        </div>

        <!-- HEADER + FILTER -->
        <div id="filter-row" class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <div>
                <div class="h5 fw-bold">Orderflow Scanner</div>
                <div class="text-muted small mb-4">Market Participant Analysis</div>
            </div>

            <div class="d-flex flex-wrap gap-2 align-items-center">
                <div id="heartbeat-indicator" class="text-muted small d-flex align-items-center gap-1"
                    title="Automated heartbeat check">
                    <div class="heartbeat-pulse"></div>
                    <span id="last-updated">Updating...</span>
                </div>
                <select id="limit-select" class="form-select form-select-sm" style="width: auto;">
                    <option value="25">Top 25</option>
                    <option value="50">Top 50</option>
                    <option value="100">Top 100</option>
                    <option value="9999" selected>All</option>
                </select>
            </div>
        </div>


        <!-- TABLE CARD -->
        <div class="card card-swing mb-5">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 table-orderflow align-middle">
                        <thead>
                            <tr>
                                <th class="text-center">#</th>

                                <th class="sortable" data-sort="kode">
                                    Kode <span class="sort-icon">‚Üï</span>
                                </th>
                                <!-- Close/High/Low Removed -->
                                <th class="text-end sortable" data-sort="vol">
                                    Vol <span class="sort-icon">‚Üï</span>
                                </th>
                                <th class="text-end sortable" data-sort="net_vol">
                                    Net Vol <span class="sort-icon">‚Üï</span>
                                </th>
                                <th class="text-end sortable" data-sort="haka_pct">
                                    % Haka <span class="sort-icon">‚Üï</span>
                                </th>
                                <th class="text-end sortable" data-sort="range">
                                    Range <span class="sort-icon">‚Üï</span>
                                </th>
                                <th class="text-end sortable" data-sort="fluktuasi">
                                    Volatilitas <span class="sort-icon">‚Üï</span>
                                </th>
                                <th class="text-end sortable" data-sort="div">
                                    ABS(CVD) <span class="sort-icon">‚Üï</span>
                                </th>
                                <th class="text-center sortable" data-sort="score">
                                    Accum Score <span class="sort-icon">‚Üï</span>
                                </th>
                                <th class="text-end sortable" data-sort="score">
                                    Prediksi <span class="sort-icon">‚Üï</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tbody-swing">
                            <!-- rows via jQuery -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- DETAIL PANEL -->
        <div class="card card-swing mb-4" id="detail-card" style="display:none;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <div class="text-muted small">Detail Emiten</div>
                        <div class="h6 mb-0" id="detail-kode">-</div>
                    </div>
                    <span id="detail-quadrant" class="quadrant-badge bg-secondary text-white">-</span>
                </div>
                <div id="detail-body" class="small text-muted">
                    <!-- detail text -->
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="component.js"></script>

    <script>
        Chart.register(ChartDataLabels);
        const isLocal = false; // Force remote for now
        const API_BASE = isLocal
            ? "http://127.0.0.1:8787"
            : "https://api-saham.mkemalw.workers.dev"; // Fixed worker URL

        const DEBUG = new URLSearchParams(window.location.search).has('debug');
        function dbg(...args) { if (DEBUG) console.log('%c[OF-DEBUG]', 'color:#2563eb;font-weight:bold', ...args); }
        function dbgWarn(...args) { if (DEBUG) console.warn('%c[OF-DEBUG]', 'color:#f59e0b;font-weight:bold', ...args); }
        function dbgTable(label, data) { if (DEBUG) { console.groupCollapsed(`%c[OF-DEBUG] ${label}`, 'color:#2563eb;font-weight:bold'); console.table(data); console.groupEnd(); } }

        $(function () {

            // --- HELPERS ---

            function formatNum(n) {
                if (n === null || n === undefined || isNaN(n)) return "-";
                return n.toLocaleString("id-ID");
            }

            function formatRangeLabel(range) {
                if (!range) return "-";
                return `${range.from.replace("T", " ")} ‚Üí ${range.to.replace("T", " ")}`;
            }

            function initRecentBubbleRange() {
                // Heartbeat placeholder
            }

            // Init Date Inputs
            initRecentBubbleRange();

            // --- FOOTPRINT QUADRANT LOGIC ---

            let currentRows = [];
            let currentSort = { key: 'score', dir: 'desc' };
            let quadChartInstance = null;

            // Quadrant Lines Plugin
            const quadrantLinesPlugin = {
                id: 'quadrantLines',
                beforeDraw: (chart) => {
                    const { ctx, chartArea, scales: { x, y } } = chart;
                    const { left, right, top, bottom } = chartArea;
                    // Zero lines
                    const x0 = x.getPixelForValue(0);
                    const y0 = y.getPixelForValue(0);

                    ctx.save();
                    ctx.beginPath();
                    ctx.strokeStyle = '#2563eb'; // Solid Blue
                    ctx.lineWidth = 2;
                    // Removed setLineDash for solid lines

                    // Vertical
                    if (x0 >= left && x0 <= right) {
                        ctx.moveTo(x0, top);
                        ctx.lineTo(x0, bottom);
                    }
                    // Horizontal
                    if (y0 >= top && y0 <= bottom) {
                        ctx.moveTo(left, y0);
                        ctx.lineTo(right, y0);
                    }
                    ctx.stroke();
                    ctx.restore();
                }
            };

            function computeQuadrantStandard(x, y) {
                if (x >= 0 && y >= 0) return 1;
                if (x < 0 && y >= 0) return 2;
                if (x < 0 && y < 0) return 3;
                return 4;
            }

            function loadData(retry = 0) {
                const url = `${API_BASE}/footprint/summary?_ts=${Date.now()}`;
                // Keep loading indicator visible during retries
                if (retry === 0) $("#loading-indicator").show();

                $.ajax({
                    url: url,
                    dataType: "json",
                    cache: false, // Disable jQuery cache
                    timeout: 20000, // 20s timeout for Cold Start
                    success: function (resp) {
                        const rawItems = resp.items || [];
                        const generatedAt = resp.generated_at;
                        const status = resp.status;
                        const reason = resp.reason;

                        // --- DEBUG LOGGING ---
                        dbg('API Response:', {
                            status, reason,
                            version: resp.version,
                            date: resp.date,
                            count: resp.count,
                            generated_at: generatedAt,
                            items_received: rawItems.length
                        });
                        if (status === 'FALLBACK' || status === 'WEEKEND_FALLBACK') {
                            dbgWarn(`‚ö†Ô∏è FALLBACK aktif: ${reason || 'unknown'}. Data bukan hari ini.`);
                        }
                        if (status === 'NO_DATA') {
                            dbgWarn('‚ùå NO_DATA: API tidak punya data sama sekali.');
                        }
                        if (status === 'DEGRADED') {
                            dbgWarn('‚ö†Ô∏è DEGRADED: Data ada tapi tidak lengkap (footprint rows kosong).');
                        }
                        if (rawItems.length > 0) {
                            const signals = {};
                            rawItems.forEach(i => { signals[i.sig] = (signals[i.sig] || 0) + 1; });
                            dbg('Signal distribution:', signals);
                            dbg('Sample item [0]:', rawItems[0]);
                            const noCtx = rawItems.filter(i => !i.ctx_found && i.ctx_found !== undefined);
                            if (noCtx.length > 0) dbgWarn(`${noCtx.length} items tanpa konteks historical (ctx_found=false)`);
                        }
                        // --- END DEBUG ---

                        // Show fallback banner if applicable
                        $("#fallback-banner").remove();
                        if (status === "FALLBACK" || status === "WEEKEND_FALLBACK") {
                            $(`<div id="fallback-banner" class="alert alert-info small py-2 px-3 mb-2 d-flex align-items-center gap-2">
                                <i class="fa-solid fa-clock-rotate-left"></i>
                                <span>Data historis: <strong>${reason || resp.date}</strong></span>
                            </div>`).insertBefore("#filter-row");
                        }

                        currentRows = rawItems
                            .filter(item => item.t && item.t.length <= 4 && (item.v || 0) >= 1000) // Filter warrants & illiquid (<1000 lots)
                            .map((item, idx) => {
                                const deltaPct = item.d || 0;
                                const priceChg = item.p || 0;
                                const vol = item.v || 0;

                                const netVol = (deltaPct * vol) / 100;
                                const hakaPct = (deltaPct + 100) / 2;
                                const quadrant = computeQuadrantStandard(deltaPct, priceChg);

                                return {
                                    _index: idx,
                                    kode: item.t,
                                    close: item.c || 0,
                                    high: item.h || item.c || 0,
                                    low: item.l || item.c || 0,
                                    vol: vol,
                                    net_vol: netVol,
                                    haka_pct: hakaPct,
                                    range: item.r || 0,
                                    fluktuasi: item.f || 0,
                                    div: item.div || 0,

                                    money: deltaPct,
                                    momentum: priceChg,
                                    quadrant: quadrant,

                                    score: item.sc || 0,
                                    signal: item.sig || '-',
                                    ctx_st: item.ctx_st || '-',
                                    ctx_net: item.ctx_net || 0
                                };
                            });

                        currentRows.sort((a, b) => b.score - a.score);

                        dbg(`Filtered: ${rawItems.length} ‚Üí ${currentRows.length} rows (removed warrants & vol<1000)`);
                        if (currentRows.length > 0) {
                            dbgTable('Top 10 by Score', currentRows.slice(0, 10).map(r => ({
                                kode: r.kode, score: r.score, signal: r.signal,
                                delta: r.money, price: r.momentum, div: r.div,
                                vol: r.vol, ctx: r.ctx_st
                            })));
                        }

                        updateDisplay(); // Render with current limit
                        $("#loading-indicator").hide();
                        /* Error Banner cleanup */
                        $("#error-banner").remove();

                        if (generatedAt) {
                            $("#last-updated").text("Last update: " + new Date(generatedAt).toLocaleTimeString());
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Failed load footprint summary:", status, error, "Retry:", retry);
                        dbgWarn(`‚ùå AJAX Error: ${status} ‚Äî ${error}`, {
                            httpStatus: xhr.status,
                            responseText: xhr.responseText?.substring(0, 200),
                            timeout: status === 'timeout',
                            retry
                        });

                        // Auto-retry once for Cold Starts (Timeout or 500)
                        if (retry < 1) {
                            dbg('üîÑ Auto-retry in 2s (cold start handling)...');
                            setTimeout(() => loadData(retry + 1), 2000);
                            return;
                        }

                        $("#loading-indicator").hide();
                        $("#stat-count").text("Error");

                        // Final Error State
                        const msg = status === 'timeout' ? "Connection Timeout (Cold Start)" : "Failed to load data";
                        if ($("#error-banner").length === 0) {
                            // Insert error banner before the filters
                            $(`<div id="error-banner" class="alert alert-warning my-3 text-center">
                                ${msg}. <br>
                                <button class="btn btn-sm btn-outline-dark mt-2" onclick="loadData(0)">Try Again</button>
                               </div>`).insertBefore("#filter-row");
                        }
                    }
                });
            }

            function renderTable(rows) {
                dbg(`üìã renderTable: ${rows.length} rows`);
                const $tbody = $("#tbody-swing");
                $tbody.empty();

                rows.forEach((s, idx) => {
                    const netClass = s.net_vol > 0 ? "text-success" : "text-danger";
                    const score = s.score.toFixed(2);
                    let sigClass = "badge bg-secondary";

                    if (s.signal === 'STRONG_BUY') sigClass = "badge bg-success";
                    else if (s.signal === 'BUY') sigClass = "badge bg-primary";
                    else if (s.signal === 'STRONG_SELL') sigClass = "badge bg-danger";
                    else if (s.signal === 'TRAP_WARNING') sigClass = "badge bg-warning text-dark";
                    else if (s.signal === 'HIDDEN_ACCUM') sigClass = "badge bg-info text-dark";

                    const $tr = $(`
                        <tr data-kode="${s.kode}">
                            <td class="text-center text-muted">${idx + 1}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="${API_BASE}/logo?symbol=${s.kode}" 
                                         style="width: 24px; height: 24px; object-fit: contain; margin-right: 8px; border-radius: 50%; background: #fff;" 
                                         onerror="this.style.display='none'">
                                    <a href="detail.html?kode=${encodeURIComponent(s.kode)}&mode=footprint" class="text-decoration-none fw-bold">${s.kode}</a>
                                </div>
                            </td>
                            <!-- High/Low Removed -->
                            <td class="text-end">${s.vol.toLocaleString()}</td>
                            <td class="text-end ${netClass}">${Math.round(s.net_vol).toLocaleString()}</td>
                            <td class="text-end">${s.haka_pct.toFixed(0)}%</td>
                            <td class="text-end">${s.range.toLocaleString()}</td>
                            <td class="text-end fw-bold text-primary">
                                ${s.fluktuasi.toFixed(2)}%
                            </td>
                            <td class="text-end fw-bold">${s.div.toFixed(1)}</td>
                            <td class="text-center">
                                <div class="fw-bold" style="color: ${score >= 0.7 ? '#16a34a' : score >= 0.5 ? '#2563eb' : '#64748b'};">
                                    ${score}
                                </div>
                                <div style="font-size:10px; color:#94a3b8;">${s.signal}</div>
                            </td>
                            <td class="text-end fw-bold">
                                ${(() => {
                            const pct = (s.score * 100).toFixed(0);
                            let label = '';
                            let color = '#64748b';

                            if (s.div > 5 && s.money > 2 && s.momentum >= -3) {
                                label = 'BREAKOUT';
                                color = '#16a34a'; // Green
                            } else if (s.momentum < -5) {
                                label = 'FALLING';
                                color = '#ef4444'; // Red
                            } else if (s.div > 5 && s.money < -2) {
                                label = 'HEAVY SELL';
                                color = '#dc2626'; // Red
                            } else if (s.div > 3 && s.momentum >= -3) {
                                label = 'WATCHING';
                                color = '#2563eb'; // Blue
                            } else {
                                label = s.signal.replace('_', ' ');
                            }

                            return `<span style="color: ${color}">${pct}% ${label}</span>`;
                        })()}
                            </td>
                        </tr>
                    `);
                    $tbody.append($tr);
                });

                $("#stat-count").text(rows.length);
            }

            function renderQuadrantChart(points) {
                const canvas = document.getElementById("quadChart");
                if (!canvas) return;

                // OPPORTUNITY FILTER: Only show positive-conviction items (net buying / high absorption)
                const filtered = points.filter(p => p.money > 0.5 || p.div > 5);
                dbg(`üìä renderQuadrantChart: ${points.length} input ‚Üí ${filtered.length} after opportunity filter (delta>0.5 or div>5)`);

                const xVals = filtered.map(p => p.money);
                const yVals = filtered.map(p => p.div);

                // Add padding for largest bubble (25px radius ~ 3 units on typical scale)
                const bubblePadding = 3;
                const xMax = xVals.length ? Math.max(10, Math.max(...xVals) + bubblePadding) : 10;
                const xMin = xVals.length ? Math.min(0, Math.min(...xVals) - 1) : 0;
                const yMax = yVals.length ? Math.max(10, Math.max(...yVals) + bubblePadding) : 10;

                const colorByContext = (p) => {
                    const delta = p.money;
                    const ctx = p.ctx_st;

                    if (delta > 5) {
                        // Strong Power ‚Äî confirmed accumulation = dark green, else bright green
                        if (ctx === 'ACCUMULATION' || ctx === 'WATCH_ACCUM') return "rgba(21, 128, 61, 0.9)";
                        return "rgba(34, 197, 94, 0.85)";
                    }
                    if (delta > 2) {
                        // Moderate Power
                        if (ctx === 'ACCUMULATION' || ctx === 'WATCH_ACCUM') return "rgba(21, 128, 61, 0.75)";
                        return "rgba(34, 197, 94, 0.65)";
                    }
                    if (delta > 0.5) {
                        // Mild positive ‚Äî light green
                        return "rgba(134, 239, 172, 0.6)";
                    }
                    // Neutral / low delta but high absorption ‚Üí blue-ish (watching)
                    return "rgba(96, 165, 250, 0.5)";
                };

                const data = {
                    datasets: [{
                        label: "Emiten",
                        data: filtered.map(p => ({
                            x: p.money,
                            y: p.div,
                            r: Math.min(Math.max(5, Math.sqrt(Math.abs(p.net_vol)) / 5), 25),
                            ...p
                        })),
                        backgroundColor: filtered.map(p => colorByContext(p)),
                        borderColor: '#fff',
                        borderWidth: 1
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const d = ctx.raw;
                                    return [
                                        `${d.kode} (${d.ctx_st})`,
                                        `Score: ${d.score.toFixed(2)} ¬∑ Delta: ${d.money.toFixed(1)}%`,
                                        `Absorption: ${d.div.toFixed(2)}`,
                                        `Context Net: ${d.ctx_net}`
                                    ];
                                }
                            }
                        },
                        datalabels: {
                            align: "top",
                            anchor: "end",
                            color: "#475569",
                            font: { size: 10, weight: "600" },
                            formatter: (v) => v.kode,
                            offset: 2,
                            clip: false
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: "Power (Net Delta %)" },
                            min: xMin, max: xMax,
                            grid: { display: false }
                        },
                        y: {
                            title: { display: true, text: "Absorption Score (ABS(CVD))" },
                            min: 0, max: yMax,
                            grid: { display: false }
                        }
                    }
                };

                if (quadChartInstance) quadChartInstance.destroy();
                // canvas defined at top of function

                quadChartInstance = new Chart(canvas, {
                    type: "bubble",
                    data,
                    options,
                    plugins: [quadrantLinesPlugin]
                });
            }

            function sortRows(key) {
                if (key === 'score') {
                    currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
                    currentRows.sort((a, b) => currentSort.dir === 'asc' ? a.score - b.score : b.score - a.score);
                } else {
                    currentSort.key = key;
                    currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
                    const factor = currentSort.dir === 'asc' ? 1 : -1;

                    currentRows.sort((a, b) => {
                        let va = a[key]; let vb = b[key];
                        if (typeof va === 'string') return va.localeCompare(vb) * factor;
                        return (va - vb) * factor;
                    });
                }
                renderTable(currentRows);
            }

            $(".sortable").on("click", function () {
                const key = $(this).data("sort");
                sortRows(key);
            });

            $("#tbody-swing").on("click", "tr", function () {
                const kode = $(this).data("kode");
                window.location.href = `detail.html?kode=${kode}&mode=footprint`;
            });


            function updateDisplay() {
                const limit = parseInt($("#limit-select").val()) || 50;
                const topRows = currentRows.slice(0, limit);
                dbg(`üîÑ updateDisplay: limit=${limit}, showing ${topRows.length}/${currentRows.length} rows`);

                renderTable(topRows);
                renderQuadrantChart(topRows);

                // Update badge/count if needed
                // $("#stat-count").text(topRows.length);
            }

            $("#limit-select").on("change", function () {
                updateDisplay();
            });

            // Heartbeat Logic
            let lastDataTime = null;
            setInterval(() => {
                dbg('‚è∞ Auto-refresh triggered (60s interval)');
                loadData();
            }, 60000); // Check every 1 minute

            // Init
            dbg('üöÄ Orderflow Scanner init', { API_BASE, timestamp: new Date().toISOString() });
            if (DEBUG) console.log('%c[OF-DEBUG] Debug mode ON ‚Äî tambahkan ?debug ke URL untuk aktifkan', 'color:#2563eb;font-weight:bold;font-size:14px');
            loadData();
        });
    </script>

    <div id="search-panel">
        <div class="mb-4">
            <input type="text" id="search-input" class="search-input p-2" placeholder="Masukkan Kode (e.g. BBRI)"
                autocomplete="off">
        </div>

        <div>
            <p class="small opacity-75 mb-2 fw-bold">RIWAYAT PENCARIAN</p>
            <div id="search-history-list">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>
</body>

</html>